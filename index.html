<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>üßß L·∫Øc L√¨ X√¨ T·∫øt 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --red-primary: #D4202F;
            --red-dark: #8B0000;
            --gold: #FFD700;
            --gold-light: #FFF4CC;
            --cream: #FFF8DC;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #D4202F;
            background: linear-gradient(to bottom, #D4202F 0%, #8B0000 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Fireworks background */
        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            animation: sparkle 3s infinite;
            opacity: 0;
        }

        @keyframes sparkle {
            0%, 100% { 
                opacity: 0; 
                transform: scale(0); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            15%, 85% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
        }

        /* Lanterns decoration */
        .lanterns {
            position: fixed;
            top: -50px;
            left: 0;
            width: 100%;
            height: 150px;
            pointer-events: none;
            z-index: 2;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
        }

        .lantern {
            width: 50px;
            height: 70px;
            background: #D4202F;
            border-radius: 0 0 25px 25px;
            position: relative;
            animation: swing 3s ease-in-out infinite;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .lantern:before {
            content: 'Á¶è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-size: 20px;
            font-weight: bold;
        }

        .lantern:after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 12px;
            background: #FFD700;
            border-radius: 50%;
        }

        @keyframes swing {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .lantern:nth-child(2) { animation-delay: 0.5s; }
        .lantern:nth-child(3) { animation-delay: 1s; }
        .lantern:nth-child(4) { animation-delay: 1.5s; }

        /* Container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            animation: slideDown 0.8s ease-out;
        }

        .header h1 {
            font-family: cursive;
            font-size: 42px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            color: #FFF4CC;
            font-size: 16px;
            font-weight: 600;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Back button */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-btn:hover,
        .back-btn:active {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        /* Screen container */
        .screen {
            background: white;
            border-radius: 30px;
            padding: 35px 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .screen:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #FFD700, #D4202F, #FFD700);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 50px;
            font-family: 'Quicksand', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #D4202F;
            color: white;
            box-shadow: 0 8px 20px rgba(212, 32, 47, 0.3);
            margin-bottom: 12px;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background: #8B0000;
            box-shadow: 0 12px 30px rgba(212, 32, 47, 0.4);
        }

        .btn-secondary {
            background: #FFD700;
            color: #8B0000;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .btn-secondary:hover,
        .btn-secondary:focus {
            background: #FFA500;
            box-shadow: 0 12px 30px rgba(255, 215, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Custom Popup Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 35px 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-icon {
            font-size: 64px;
            margin-bottom: 18px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #8B0000;
            margin-bottom: 12px;
        }

        .modal-message {
            font-size: 15px;
            color: #666;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .modal-room-code {
            background: #FFF4CC;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 28px;
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: 700;
            color: #D4202F;
            letter-spacing: 3px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 50px;
            font-family: 'Quicksand', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-btn-primary {
            background: #D4202F;
            color: white;
            box-shadow: 0 8px 20px rgba(212, 32, 47, 0.3);
        }

        .modal-btn-primary:hover,
        .modal-btn-primary:active {
            background: #8B0000;
            transform: scale(1.02);
        }

        .modal-btn-secondary {
            background: #FFD700;
            color: #8B0000;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .modal-btn-secondary:hover,
        .modal-btn-secondary:active {
            background: #FFA500;
            transform: scale(1.02);
        }

        /* Input fields */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            color: #8B0000;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #FFE4E1;
            border-radius: 15px;
            font-family: 'Quicksand', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B0000' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #D4202F;
            box-shadow: 0 0 0 3px rgba(212, 32, 47, 0.1);
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            gap: 12px;
            margin: 18px 0;
        }

        .radio-option {
            flex: 1;
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-option label {
            display: block;
            padding: 18px 15px;
            background: #FFF8DC;
            border: 2px solid transparent;
            border-radius: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            color: #8B0000;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #D4202F;
            color: white;
            border-color: #FFD700;
            transform: scale(1.03);
        }

        /* Denomination buttons */
        .denomination-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 18px 0;
        }

        .denom-btn {
            padding: 14px 10px;
            background: #FFF4CC;
            border: 2px solid #FFD700;
            border-radius: 15px;
            font-weight: 700;
            color: #8B0000;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .denom-btn:hover,
        .denom-btn:active {
            background: #FFD700;
            transform: scale(1.05);
        }

        .denom-btn.selected {
            background: #D4202F;
            color: white;
            border-color: #8B0000;
        }

        /* Selected denominations list */
        .selected-list {
            margin: 18px 0;
        }

        .selected-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .selected-item.special-prize {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .selected-item-value {
            font-weight: 700;
            color: #8B0000;
            font-size: 15px;
            flex: 1;
        }

        .selected-item-type {
            font-size: 11px;
            color: #4CAF50;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #D4202F;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .quantity-btn:hover,
        .quantity-btn:active {
            background: #8B0000;
            transform: scale(1.1);
        }

        .quantity-display {
            min-width: 30px;
            text-align: center;
            font-weight: 700;
            color: #8B0000;
        }

        /* Total budget */
        .total-budget {
            background: linear-gradient(to right, #FFD700, #FFA500);
            padding: 18px;
            border-radius: 18px;
            text-align: center;
            margin: 18px 0;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .total-budget-label {
            font-size: 13px;
            color: #8B0000;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .total-budget-amount {
            font-size: 28px;
            font-weight: 700;
            color: #8B0000;
            font-family: serif;
        }

        /* Custom prize input */
        .custom-prize-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .custom-prize-input input:first-child {
            flex: 3;
        }

        .custom-prize-input input:last-child {
            flex: 7;
        }

        /* Room code - CENTERED */
        .room-code {
            background: #FFF4CC;
            padding: 22px;
            border-radius: 18px;
            margin: 18px 0;
            text-align: center;
        }

        .room-code-label {
            font-size: 14px;
            color: #8B0000;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .room-code-value {
            font-size: 32px;
            font-weight: 700;
            color: #D4202F;
            letter-spacing: 4px;
            font-family: 'Courier New', monospace;
        }

        /* Player list */
        .player-list {
            margin: 18px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #D4202F;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            font-size: 16px;
        }

        .player-name {
            flex: 1;
            font-weight: 600;
            color: #8B0000;
        }

        .player-status {
            background: #FFD700;
            padding: 5px 14px;
            border-radius: 18px;
            font-weight: 700;
            color: #8B0000;
            font-size: 13px;
        }

        .player-status.waiting {
            background: #4CAF50;
            color: white;
        }
        .player-status.playing {
            background: #4CAF50;
            color: white;
        }
        .player-prize {
            background: #FFD700;
            padding: 5px 14px;
            border-radius: 18px;
            font-weight: 700;
            color: #8B0000;
            font-size: 13px;
        }

        .player-prize.special {
            background: #4CAF50;
            color: white;
        }

        /* Prize inventory */
        .prize-inventory {
            margin: 18px 0;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 8px;
        }

        .prize-item.special {
            background: #E8F5E9;
        }

        .prize-value {
            font-weight: 700;
            color: #8B0000;
            flex: 1;
        }

        .prize-type-badge {
            font-size: 10px;
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .prize-count {
            font-weight: 600;
            color: #666;
        }

        .prize-count.claimed {
            color: #D4202F;
        }

        /* Shake animation */
        .envelope-container {
            text-align: center;
            padding: 35px 0;
        }

        .envelope {
            width: 180px;
            height: 110px;
            margin: 0 auto;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .envelope.shaking {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg) translateX(0); }
            25% { transform: rotate(-8deg) translateX(-8px); }
            75% { transform: rotate(8deg) translateX(8px); }
        }

        .envelope-front {
            width: 100%;
            height: 100%;
            background: #D4202F;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 12px 35px rgba(139, 0, 0, 0.4);
        }

        .envelope-front:after {
            content: 'Á¶è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            color: #FFD700;
            font-weight: 700;
        }

        .shake-instruction {
            margin-top: 25px;
            font-size: 16px;
            color: #FFD700;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Result display */
        .result-title {
            font-family: cursive;
            font-size: 38px;
            color: #D4202F;
            margin-bottom: 18px;
        }

        .result-prize {
            font-size: 56px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin: 18px 0;
            font-family: serif;
        }

        .result-prize.special {
            font-size: 32px;
            color: #4CAF50;
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 35px;
        }

        .spinner {
            width: 55px;
            height: 55px;
            margin: 0 auto 18px;
            border: 4px solid #FFF4CC;
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #8B0000;
            font-weight: 600;
            font-size: 15px;
        }

        /* Waiting screen */
        .waiting-screen {
            text-align: center;
            padding: 35px 0;
        }

        .waiting-icon {
            font-size: 72px;
            margin: 25px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-18px); }
        }

        .waiting-message {
            font-size: 16px;
            color: #8B0000;
            font-weight: 600;
            margin: 18px 0;
        }

        /* Status badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #4CAF50;
            color: white;
            padding: 12px 22px;
            border-radius: 28px;
            font-weight: 700;
            margin: 18px 0;
            animation: fadeIn 0.5s;
        }

        .status-badge:before {
            content: '‚úì';
            font-size: 18px;
        }

        /* Activity item */
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .activity-time {
            font-size: 11px;
            color: #999;
            margin-right: 12px;
            white-space: nowrap;
            min-width: 50px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-player {
            font-weight: 700;
            color: #8B0000;
            margin-bottom: 4px;
        }

        .activity-prize {
            font-size: 13px;
            color: #D4202F;
            font-weight: 600;
        }

        .activity-prize.special {
            color: #4CAF50;
        }

        .activity-badge {
            background: #FFD700;
            color: #8B0000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .activity-badge.new {
            background: #4CAF50;
            color: white;
        }

        /* Tab navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin: 18px 0;
            background: #FFF4CC;
            border-radius: 15px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 12px;
            font-family: 'Quicksand', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #8B0000;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn.active {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 34px;
            }

            .denomination-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .radio-group {
                flex-direction: column;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        h2 {
            color: #8B0000;
            margin-bottom: 22px;
            text-align: center;
            font-size: 22px;
        }

        h3 {
            color: #8B0000;
            margin: 22px 0 14px;
            font-size: 16px;
        }
    </style>
</head>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  set,
  get,
  onValue,
  update,
  remove,
  push
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB83HpHO5PRHkJ8YDLdDAySOmIQVtTtUXk",
  authDomain: "lac-li-xi-2026-8f32c.firebasapp.com",
  databaseURL: "https://lac-li-xi-2026-8f32c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lac-li-xi-2026-8f32c",
  storageBucket: "lac-li-xi-2026-8f32c.firebasestorage.app",
  messagingSenderId: "230674094866",
  appId: "1:230674094866:web:d7fc3a0d9d357aba32b1cb"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

window.firebaseDB = {
  database,
  ref,
  set,
  get,
  onValue,
  update,
  remove,
  push
};

console.log("üî• FIREBASE READY");
</script>

<body>
    <!-- Decorative elements -->
    <div class="fireworks" id="fireworks"></div>
    <div class="lanterns">
        <div class="lantern"></div>
        <div class="lantern"></div>
        <div class="lantern"></div>
        <div class="lantern"></div>
    </div>

    <!-- Custom Modal Popup -->
    <div id="room-choice-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-icon">üè†</div>
            <div class="modal-title">Ph√≤ng ƒë√£ t·ªìn t·∫°i</div>
            <div class="modal-message">
                B·∫°n c√≥ ph√≤ng ƒëang ho·∫°t ƒë·ªông
            </div>
            <div class="modal-room-code" id="modal-room-code">XXXXX</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="continueOldRoomFromModal()">
                    üîÑ TI·∫æP T·ª§C
                </button>
                <button class="modal-btn modal-btn-secondary" onclick="createNewRoomFromModal()">
                    üÜï T·∫†O M·ªöI
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üßß L·∫Øc L√¨ X√¨ T·∫øt 2026</h1>
            <p>V·∫°n s·ª± nh∆∞ √Ω - Ph√°t t√†i ph√°t l·ªôc</p>
        </div>

        <!-- Screen 1: Home -->
        <div id="screen-home" class="screen">
            <h2>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi tr√≤ ch∆°i l√¨ x√¨!</h2>
            <button class="btn btn-primary" onclick="handleCreateRoomClick()">üéä T·∫†O PH√íNG</button>
            <button class="btn btn-secondary" onclick="navigateTo('join-room')">üéâ THAM GIA PH√íNG</button>
            
            <!-- Clear data button -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="resetApp()" style="background: none; border: none; color: #FFF4CC; font-size: 12px; cursor: pointer; text-decoration: underline; opacity: 0.7;">
                    üîÑ X√≥a d·ªØ li·ªáu & l√†m m·ªõi
                </button>
            </div>
        </div>

        <!-- Screen 2: Create Room -->
        <div id="screen-create-room" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>T·∫°o Ph√≤ng M·ªõi</h2>
            
            <div class="form-group">
                <label>üë§ T√™n ch·ªß ph√≤ng</label>
                <input type="text" id="host-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            </div>

            <div class="form-group">
                <label>üé≤ S·ªë l∆∞·ª£t l·∫Øc</label>
                <input type="number" id="shake-count" placeholder="Nh·∫≠p s·ªë l∆∞·ª£t" min="1" value="10">
            </div>

            <div class="form-group">
                <label>üéÆ Ch·∫ø ƒë·ªô ch∆°i</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" name="mode" id="mode-online" value="online" checked>
                        <label for="mode-online">
                            üåê<br>Online<br>
                            <small style="font-size: 11px; font-weight: 400;">QR/M√£ ph√≤ng</small>
                        </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="mode" id="mode-local" value="local">
                        <label for="mode-local">
                            üì±<br>Local<br>
                            <small style="font-size: 11px; font-weight: 400;">Truy·ªÅn tay</small>
                        </label>
                    </div>
                </div>
            </div>

            <h3>üí∞ C·∫•u h√¨nh ph·∫ßn th∆∞·ªüng ti·ªÅn</h3>
            
            <div class="denomination-grid">
                <button class="denom-btn" onclick="selectDenom('20K')">20K</button>
                <button class="denom-btn" onclick="selectDenom('50K')">50K</button>
                <button class="denom-btn" onclick="selectDenom('100K')">100K</button>
                <button class="denom-btn" onclick="selectDenom('200K')">200K</button>
                <button class="denom-btn" onclick="selectDenom('500K')">500K</button>
                <button class="denom-btn" onclick="addCustomDenom()">‚ûï Th√™m</button>
            </div>

            <h3>üéÅ Ph·∫ßn th∆∞·ªüng kh√°c (kh√¥ng t√≠nh ng√¢n s√°ch)</h3>
            <div id="special-prizes-container"></div>
            <button class="btn btn-secondary" onclick="addSpecialPrize()" style="font-size: 14px; padding: 12px;">
                ‚ûï Th√™m ph·∫ßn th∆∞·ªüng kh√°c
            </button>

            <div id="selected-denoms" class="selected-list"></div>

            <div class="total-budget">
                <div class="total-budget-label">T·ªïng ng√¢n s√°ch (ch·ªâ ti·ªÅn)</div>
                <div class="total-budget-amount" id="total-budget">0ƒë</div>
            </div>

            <button class="btn btn-primary" onclick="createRoom()">üéä T·∫†O PH√íNG</button>
        </div>

        <!-- Screen 3: Join Room -->
        <div id="screen-join-room" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>Tham Gia Ph√≤ng</h2>
            
            <div class="form-group">
                <label>üîë M√£ ph√≤ng</label>
                <input type="text" id="join-room-code" placeholder="Nh·∫≠p m√£ ph√≤ng" style="text-transform: uppercase;">
            </div>

            <button class="btn btn-primary" onclick="joinRoom()">üéâ THAM GIA</button>
        </div>

        <!-- Screen 4: Enter Name -->
        <div id="screen-enter-name" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>Th√¥ng tin ng∆∞·ªùi ch∆°i</h2>
            
            <div class="form-group">
                <label>üë§ T√™n c·ªßa b·∫°n</label>
                <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            </div>

            <button class="btn btn-primary" onclick="submitPlayerName()">‚úÖ X√ÅC NH·∫¨N</button>
        </div>

        <!-- Screen 5: Welcome -->
        <div id="screen-welcome" class="screen hidden">
            <div style="text-align: center; padding: 35px 0;">
                <div style="font-size: 72px; margin-bottom: 18px;">üéä</div>
                <h2 style="font-size: 28px; margin-bottom: 14px;">Xin ch√†o,</h2>
                <h3 id="welcome-name" style="color: #D4202F; font-size: 32px; font-family: cursive; text-align: center; margin: 0;">Ng∆∞·ªùi ch∆°i</h3>
                <p style="color: #666; margin-top: 18px; font-size: 15px;">Ch√∫c b·∫°n may m·∫Øn!</p>
            </div>
            <button class="btn btn-primary" onclick="navigateTo('waiting')">üéØ TI·∫æP T·ª§C</button>
        </div>

        <!-- Screen 6: Admin Dashboard -->
        <div id="screen-admin" class="screen hidden">
            <button class="back-btn" onclick="confirmBackToHome()">‚Üê</button>
            <h2>B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
            <div class="room-code">
                <div class="room-code-label">M√£ ph√≤ng</div>
                <div class="room-code-value" id="room-code-display">XXXX</div>
            </div>
            <h3>üë• Ng∆∞·ªùi tham gia (<span id="player-count">0</span>)</h3>
            <div id="player-list" class="player-list">
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <div class="empty-state-text">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o</div>
                </div>
            </div>

            <h3>üéÅ Kho ph·∫ßn th∆∞·ªüng</h3>
            <div id="prize-inventory" class="prize-inventory"></div>

            <div style="display: flex; gap: 10px; margin-top: 28px;">
                <button class="btn btn-primary" onclick="startGame()" style="flex: 1;">üöÄ B·∫ÆT ƒê·∫¶U</button>
                <button class="btn btn-secondary" onclick="shareRoom()" style="flex: 1;">üì§ M·ªúI B·∫†N</button>
            </div>
        </div>

        <!-- Screen 6.5: Host After Start -->
        <div id="screen-host-after-start" class="screen hidden">
            <button class="back-btn" onclick="confirmBackToHome()">‚Üê</button>
            <h2>Ph√≤ng ƒë√£ b·∫Øt ƒë·∫ßu</h2>
            
            <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 64px; margin-bottom: 18px;">üéÆ</div>
                <p style="color: #8B0000; font-weight: 600; font-size: 16px;">
                    Tr√≤ ch∆°i ƒëang di·ªÖn ra
                </p>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="hostJoinGame()" style="flex: 1;">
                    üéä THAM GIA CH∆†I
                </button>
                <button class="btn btn-secondary" onclick="navigateTo('host-observe', false, true)" style="flex: 1;">
                    üëÅÔ∏è QUAN S√ÅT
                </button>
            </div>

            <div class="room-code" style="margin-top: 20px;">
                <div class="room-code-label">M√£ ph√≤ng</div>
                <div class="room-code-value" id="room-code-display-2">XXXX</div>
            </div>
        </div>

        <!-- Screen 6.6: Host Observe -->
        <div id="screen-host-observe" class="screen hidden">
            <button class="back-btn" onclick="confirmBackToHome()">‚Üê</button>
            <h2>Ph·∫ßn Quan S√°t</h2>

            <div class="tab-navigation">
            <button class="tab-btn active"
        onclick="switchTab('waiting-players', this)">
                ‚è≥ ƒêang ch·ªù
            </button>

            <button class="tab-btn"
        onclick="switchTab('recent-winners', this)">
               üéÅ M·ªõi tr√∫ng
            </button>
            </div>

            <!-- Tab: Waiting Players -->
            <div id="tab-waiting-players" class="tab-content active">
                <h3>üë• Ng∆∞·ªùi ch∆°i ƒëang ch·ªù (<span id="waiting-player-count">0</span>)</h3>
                <div id="waiting-player-list" class="player-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚è≥</div>
                        <div class="empty-state-text">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o ƒëang ch·ªù</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Recent Winners -->
            <div id="tab-recent-winners" class="tab-content">
                <h3>üéä Ng∆∞·ªùi r√∫t l√¨ x√¨ g·∫ßn nh·∫•t</h3>
                <div id="recent-activity-list" class="player-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 28px;">
                <button class="btn btn-secondary" onclick="shareRoom()">üì§ M·ªúI TH√äM B·∫†N</button>
            </div>
        </div>

        <!-- Screen 7: Waiting Room -->
        <div id="screen-waiting" class="screen hidden">
            <div class="waiting-screen">
                <div class="waiting-icon">‚è≥</div>
                <h2>Ch·ªù ch·ªß ph√≤ng...</h2>
                <p class="waiting-message">T√≠ch c·ª±c l·∫Øc - v·∫≠n may s·∫Ω ƒë·∫øn! üçÄ</p>
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Screen 8: Game Started -->
        <div id="screen-started" class="screen hidden">
            <div style="text-align: center; padding: 35px 0;">
                <div style="font-size: 72px; margin-bottom: 18px;">üéâ</div>
                <div class="status-badge">ƒê√É B·∫ÆT ƒê·∫¶U</div>
                <h2 style="margin: 18px 0;">Tr√≤ ch∆°i ƒë√£ b·∫Øt ƒë·∫ßu!</h2>
                <p style="color: #666; font-size: 15px;">S·∫µn s√†ng nh·∫≠n l√¨ x√¨ th√¥i n√†o!</p>
            </div>
            <button class="btn btn-primary" onclick="navigateTo('shake')">üéä OK, B·∫ÆT ƒê·∫¶U CH∆†I!</button>
        </div>

        <!-- Screen 9: Shake -->
        <div id="screen-shake" class="screen hidden">
            <button class="back-btn" onclick="confirmBackFromShake()">‚Üê</button>
            <h2>L·∫Øc ƒë·ªÉ nh·∫≠n l√¨ x√¨!</h2>
            
            <div class="envelope-container">
                <div class="envelope" id="envelope" onclick="startShaking()">
                    <div class="envelope-front"></div>
                </div>
                <p class="shake-instruction" id="shake-text">üëÜ Ch·∫°m v√†o bao l√¨ x√¨ v√† l·∫Øc ƒëi·ªán tho·∫°i</p>
            </div>

            <div style="text-align: center; margin-top: 28px;">
                <p style="color: #FFD700; font-weight: 600; font-size: 16px;">
                    L∆∞·ª£t c√≤n l·∫°i: <span id="remaining-shakes" style="font-size: 22px; font-weight: 700;">10</span>
                </p>
            </div>
        </div>

        <!-- Screen 10: Prize Result -->
        <div id="screen-result" class="screen hidden">
            <div style="text-align: center; padding: 18px 0;">
                <div style="font-size: 88px; margin-bottom: 18px;">üéä</div>
                <h2 class="result-title">Ch√∫c m·ª´ng!</h2>
                <p style="color: #666; margin-bottom: 18px;">B·∫°n ƒë√£ tr√∫ng</p>
                <div class="result-prize" id="prize-amount">100K</div>
                
                <div style="background: #FFF4CC; padding: 18px; border-radius: 18px; margin: 28px 0;">
                    <p style="color: #8B0000; font-weight: 700; margin-bottom: 8px;">
                        üë§ <span id="winner-name">Ng∆∞·ªùi ch∆°i</span>
                    </p>
                    <p style="color: #8B0000; font-weight: 700;">
                        üéÅ <span id="winner-prize">100K</span>
                    </p>
                </div>

                <div id="prize-action-buttons">
                    <button class="btn btn-primary" onclick="continueShaking()">üîÑ TI·∫æP T·ª§C CH∆†I</button>
                </div>
            </div>
        </div>
    </div>
<script>
    // ========== 1. GAME STATE ==========
let gameState = {
    mode: 'online',
    hostName: '',
    shakeCount: 10,
    roomCode: '',
    roomLink: '',
    denominations: {},
    specialPrizes: {},
    denominationsBackup: {},
    specialPrizesBackup: {},
    players: [],
    waitingPlayers: [],
    winners: [],
    recentActivity: [],
    currentPlayer: '',
    currentPrize: '',
    currentPrizeType: 'money',
    isShaking: false,
    remainingShakes: 10,
    currentScreen: 'home',
    isHost: false,
    gameStarted: false,
    roomStatus: 'idle',
    roomCreatedAt: 0,
    playerRoomCode: ''
};

const STORAGE_KEY = 'tet_lixi_game_state';
const ROOM_EXPIRY_TIME = 24 * 60 * 60 * 1000; // 24 hours
let navigationHistory = ['home'];
let specialPrizeCounter = 0;
let playersListenerStarted = false;
let playersListenerRoom = null;
let shakeTimeout;
let shakeStartTime;
let roomStatusListener = null;

// ========== 2. NAVIGATION ==========
window.navigateTo = function (screenId, clearHistory = false, replaceHistory = false) {
    if (clearHistory) {
        navigationHistory = [screenId];
    } else if (replaceHistory) {
        navigationHistory[navigationHistory.length - 1] = screenId;
    } else {
        navigationHistory.push(screenId);
    }

    gameState.currentScreen = screenId;
    saveGameState();
    showScreen(screenId);

    if (replaceHistory) {
        history.replaceState({ screen: screenId }, '', '#' + screenId);
    } else {
        history.pushState({ screen: screenId }, '', '#' + screenId);
    }
};

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.add('hidden');
    });
    const targetScreen = document.getElementById('screen-' + screenId);
    if (targetScreen) {
        targetScreen.classList.remove('hidden');
    }
    
    setTimeout(() => initTouchSupport(), 100);
}

function goBack() {
    if (gameState.currentScreen === 'host-observe' && gameState.isHost && gameState.gameStarted) {
        navigateTo('host-after-start');
        return;
    }
    
    if (navigationHistory.length > 1) {
        navigationHistory.pop();
        const previousScreen = navigationHistory[navigationHistory.length - 1];
        gameState.currentScreen = previousScreen;
        saveGameState();
        showScreen(previousScreen);
    } else {
        navigateTo('home', true);
    }
}

window.addEventListener('popstate', function(event) {
    goBack();
});

// ========== 3. STORAGE ==========
function saveGameState() {
    try {
        gameState.savedTime = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
    } catch (e) {
        console.error('Error saving:', e);
    }
}

function loadGameState() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        
        const loaded = JSON.parse(saved);
        
        if (!loaded || typeof loaded !== 'object') {
            clearGameState();
            return;
        }
        
        const savedTime = loaded.savedTime || 0;
        const currentTime = Date.now();
        
        if (currentTime - savedTime > ROOM_EXPIRY_TIME) {
            console.log('‚è∞ Room expired, clearing state');
            clearGameState();
            return;
        }
        
        // ‚úÖ CH·ªà L∆ØU STATE, KH√îNG RESTORE M√ÄN H√åNH
        Object.assign(gameState, loaded);
        
        // RESTORE LISTENERS cho HOST
        if (gameState.isHost && gameState.roomCode) {
            listenPlayersRealtime();
        }
        
        // RESTORE LISTENER cho PLAYER
        if (!gameState.isHost && gameState.playerRoomCode) {
            listenRoomStatus();
        }
        
    } catch (e) {
        console.error('Error loading:', e);
        clearGameState();
    }
}

function clearGameState() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        Object.assign(gameState, {
            mode: 'online',
            hostName: '',
            shakeCount: 10,
            roomCode: '',
            roomLink: '',
            denominations: {},
            specialPrizes: {},
            denominationsBackup: {},
            specialPrizesBackup: {},
            players: [],
            waitingPlayers: [],
            winners: [],
            recentActivity: [],
            currentPlayer: '',
            currentPrize: '',
            currentPrizeType: 'money',
            isShaking: false,
            remainingShakes: 10,
            currentScreen: 'home',
            isHost: false,
            gameStarted: false,
            roomStatus: 'idle',
            roomCreatedAt: 0,
            playerRoomCode: ''
        });
        navigationHistory = ['home'];
        playersListenerStarted = false;
        playersListenerRoom = null;
        
        // DETACH ROOM STATUS LISTENER
        if (roomStatusListener) {
            roomStatusListener();
            roomStatusListener = null;
        }
    } catch (e) {
        console.error('Error clearing:', e);
    }
}

function resetApp() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu v√† l√†m m·ªõi ·ª©ng d·ª•ng?')) {
        clearGameState();
        sessionStorage.clear();
        window.location.href = window.location.pathname;
    }
}

function restoreAdminDashboard() {
    try {
        if (!gameState.roomCode || !gameState.roomLink) {
            throw new Error('Missing room data');
        }
        
        if (!gameState.denominationsBackup || Object.keys(gameState.denominationsBackup).length === 0) {
            gameState.denominationsBackup = JSON.parse(JSON.stringify(gameState.denominations));
        }

        if (!gameState.specialPrizesBackup || Object.keys(gameState.specialPrizesBackup).length === 0) {
            gameState.specialPrizesBackup = JSON.parse(JSON.stringify(gameState.specialPrizes));
        }
        
        const displayElements = [
            document.getElementById('room-code-display'),
            document.getElementById('room-code-display-2')
        ];
        
        displayElements.forEach(el => {
            if (el) el.textContent = gameState.roomCode;
        });
        
        updatePlayerList();
        updatePrizeInventory();
        updateWaitingPlayerList();
        updateRecentActivityList();
        updateRoomStatus();
    } catch (e) {
        console.error('Error restoring dashboard:', e);
        throw e;
    }
}

// ========== 4. MODAL POPUP ==========
function showRoomChoiceModal() {
    const modal = document.getElementById('room-choice-modal');
    const roomCodeEl = document.getElementById('modal-room-code');
    
    if (roomCodeEl) {
        roomCodeEl.textContent = gameState.roomCode;
    }
    
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideRoomChoiceModal() {
    const modal = document.getElementById('room-choice-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

window.continueOldRoomFromModal = function() {
    hideRoomChoiceModal();
    continueOldRoom();
};

window.createNewRoomFromModal = function() {
    hideRoomChoiceModal();
    resetForNewRoom();
    resetCreateRoomForm();
    navigateTo('create-room');
};

// ========== 5. FIREWORKS ==========
function createSparks() {
    const fireworks = document.getElementById('fireworks');
    if (!fireworks) return;
    for (let i = 0; i < 30; i++) {
        const spark = document.createElement('div');
        spark.className = 'spark';
        spark.style.left = Math.random() * 100 + '%';
        spark.style.top = Math.random() * 100 + '%';
        spark.style.animationDelay = Math.random() * 3 + 's';
        fireworks.appendChild(spark);
    }
}

// ========== 6. DENOMINATION MANAGEMENT ==========
function selectDenom(value) {
    if (!gameState.denominations[value]) {
        gameState.denominations[value] = 1;
    } else {
        gameState.denominations[value]++;
    }
    updateDenomList();
}

function addCustomDenom() {
    const value = prompt('Nh·∫≠p gi√° tr·ªã (v√≠ d·ª•: 1000):');
    if (value && !isNaN(value)) {
        const key = parseInt(value) >= 1000 ? (parseInt(value) / 1000) + 'K' : value + 'ƒë';
        gameState.denominations[key] = 1;
        updateDenomList();
    }
}

function updateQuantity(denom, delta) {
    gameState.denominations[denom] += delta;
    if (gameState.denominations[denom] <= 0) {
        delete gameState.denominations[denom];
    }
    updateDenomList();
}

function updateSpecialQuantity(prize, delta) {
    gameState.specialPrizes[prize] += delta;
    if (gameState.specialPrizes[prize] <= 0) {
        delete gameState.specialPrizes[prize];
    }
    updateDenomList();
}

function updateDenomList() {
    const container = document.getElementById('selected-denoms');
    if (!container) return;
    
    container.innerHTML = '';
    
    let total = 0;
    
    for (const [denom, qty] of Object.entries(gameState.denominations)) {
        const value = parseFloat(denom.replace(/[^0-9.]/g, ''));
        const multiplier = denom.includes('K') ? 1000 : 1;
        total += value * multiplier * qty;

        const item = document.createElement('div');
        item.className = 'selected-item';
        item.innerHTML = `
            <div class="selected-item-value">üí∞ ${denom}</div>
            <div class="quantity-control">
                <button class="quantity-btn" onclick="updateQuantity('${denom}', -1)">‚àí</button>
                <div class="quantity-display">${qty}</div>
                <button class="quantity-btn" onclick="updateQuantity('${denom}', 1)">+</button>
            </div>
        `;
        container.appendChild(item);
    }
    
    for (const [prize, qty] of Object.entries(gameState.specialPrizes)) {
        const item = document.createElement('div');
        item.className = 'selected-item special-prize';
        item.innerHTML = `
            <div style="flex: 1;">
                <div class="selected-item-type">Ph·∫ßn th∆∞·ªüng kh√°c</div>
                <div class="selected-item-value">üéÅ ${prize}</div>
            </div>
            <div class="quantity-control">
                <button class="quantity-btn" onclick="updateSpecialQuantity('${escapeHtml(prize)}', -1)">‚àí</button>
                <div class="quantity-display">${qty}</div>
                <button class="quantity-btn" onclick="updateSpecialQuantity('${escapeHtml(prize)}', 1)">+</button>
            </div>
        `;
        container.appendChild(item);
    }

    const budgetEl = document.getElementById('total-budget');
    if (budgetEl) {
        budgetEl.textContent = total.toLocaleString('vi-VN') + 'ƒë';
    }
    
    saveGameState();
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// ========== 7. SPECIAL PRIZES ==========
function addSpecialPrize() {
    specialPrizeCounter++;
    const container = document.getElementById('special-prizes-container');
    const id = 'special-' + specialPrizeCounter;
    
    const prizeDiv = document.createElement('div');
    prizeDiv.className = 'custom-prize-input';
    prizeDiv.id = id;
    prizeDiv.innerHTML = `
        <input type="text" placeholder="Lo·∫°i (vd: H√¨nh ph·∫°t)" id="${id}-type">
        <input type="text" placeholder="N·ªôi dung (vd: U·ªëng 1 ly)" id="${id}-content">
        <input type="number" placeholder="S·ªë l·∫ßn" value="1" min="1" style="width: 70px;" id="${id}-count">
        <button onclick="removeSpecialPrize('${id}')" style="background: #D4202F; color: white; border: none; border-radius: 10px; padding: 14px; cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
    `;
    
    container.appendChild(prizeDiv);
}

function removeSpecialPrize(id) {
    const element = document.getElementById(id);
    if (element) {
        element.remove();
    }
}

function collectSpecialPrizes() {
    const container = document.getElementById('special-prizes-container');
    const inputs = container.querySelectorAll('.custom-prize-input');
    
    gameState.specialPrizes = {};
    
    inputs.forEach(input => {
        const id = input.id;
        const typeInput = document.getElementById(id + '-type');
        const contentInput = document.getElementById(id + '-content');
        const countInput = document.getElementById(id + '-count');
        
        if (typeInput && contentInput && countInput) {
            const type = typeInput.value.trim();
            const content = contentInput.value.trim();
            const count = parseInt(countInput.value) || 1;
            
            if (type && content) {
                const key = type + ': ' + content;
                gameState.specialPrizes[key] = count;
            }
        }
    });
}

// ========== 8. ROOM MANAGEMENT ==========
function generateRoomCode() {
    return 'TET' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

// ‚úÖ FIX: H√†m x·ª≠ l√Ω click n√∫t "T·∫†O PH√íNG"
window.handleCreateRoomClick = function() {
    // Ki·ªÉm tra c√≥ ph√≤ng c≈© kh√¥ng
    const hasOldRoom = gameState.isHost && gameState.roomCode;
    
    if (hasOldRoom) {
        // Hi·ªán CUSTOM MODAL
        showRoomChoiceModal();
    } else {
        // Kh√¥ng c√≥ ph√≤ng c≈© - reset form v√† ƒëi t·ªõi m√†n t·∫°o ph√≤ng
        resetCreateRoomForm();
        navigateTo('create-room');
    }
};

function continueOldRoom() {
    if (gameState.gameStarted) {
        navigateTo('host-after-start');
    } else {
        navigateTo('admin');
    }
    restoreAdminDashboard();
    listenPlayersRealtime();
}

// ‚úÖ FIX: Reset state khi t·∫°o ph√≤ng m·ªõi
function resetForNewRoom() {
    const wasHost = gameState.isHost;
    clearGameState();
    gameState.isHost = wasHost;
    saveGameState();
}

// ‚úÖ FIX: Reset form t·∫°o ph√≤ng (ch·ªâ g·ªçi khi c·∫ßn)
function resetCreateRoomForm() {
    setTimeout(() => {
        const hostNameInput = document.getElementById('host-name');
        if (hostNameInput) hostNameInput.value = '';
        
        const shakeCountInput = document.getElementById('shake-count');
        if (shakeCountInput) shakeCountInput.value = '10';
        
        const modeOnline = document.getElementById('mode-online');
        if (modeOnline) modeOnline.checked = true;
        
        gameState.denominations = {};
        gameState.specialPrizes = {};
        
        const specialPrizesContainer = document.getElementById('special-prizes-container');
        if (specialPrizesContainer) {
            specialPrizesContainer.innerHTML = '';
        }
        
        specialPrizeCounter = 0;
        updateDenomList();
    }, 100);
}

async function createRoom() {
    const createBtn = document.querySelector('#screen-create-room .btn-primary');
    if (createBtn) {
        createBtn.disabled = true;
        createBtn.textContent = '‚è≥ ƒêang t·∫°o...';
    }

    // ‚úÖ FIX: L·∫•y gi√° tr·ªã TR∆Ø·ªöC khi validate
    const hostNameInput = document.getElementById('host-name');
    const shakeCountInput = document.getElementById('shake-count');
    const modeRadio = document.querySelector('input[name="mode"]:checked');
    
    if (!hostNameInput) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y input host-name');
        if (createBtn) {
            createBtn.disabled = false;
            createBtn.textContent = 'üéä T·∫†O PH√íNG';
        }
        return;
    }

    const hostName = hostNameInput.value.trim();
    const shakeCount = parseInt(shakeCountInput?.value || '10');
    const mode = modeRadio?.value || 'online';

    if (!hostName) {
        alert('Vui l√≤ng nh·∫≠p t√™n ch·ªß ph√≤ng!');
        if (createBtn) {
            createBtn.disabled = false;
            createBtn.textContent = 'üéä T·∫†O PH√íNG';
        }
        return;
    }

    collectSpecialPrizes();

    if (
        Object.keys(gameState.denominations).length === 0 &&
        Object.keys(gameState.specialPrizes).length === 0
    ) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ph·∫ßn th∆∞·ªüng!');
        if (createBtn) {
            createBtn.disabled = false;
            createBtn.textContent = 'üéä T·∫†O PH√íNG';
        }
        return;
    }

    const roomCode = generateRoomCode();

    gameState.players = [];
    gameState.winners = [];
    gameState.recentActivity = [];
    
    gameState.denominationsBackup = JSON.parse(JSON.stringify(gameState.denominations));
    gameState.specialPrizesBackup = JSON.parse(JSON.stringify(gameState.specialPrizes));
    gameState.hostName = hostName;
    gameState.shakeCount = shakeCount;
    gameState.remainingShakes = shakeCount;
    gameState.mode = mode;
    gameState.roomCode = roomCode;
    gameState.roomLink = location.origin + location.pathname + '?room=' + roomCode;
    gameState.isHost = true;
    gameState.gameStarted = false;
    gameState.roomStatus = 'idle';
    gameState.roomCreatedAt = Date.now();

    saveGameState();

    const { database, ref, set } = window.firebaseDB;

    try {
        await set(ref(database, `rooms/${roomCode}`), {
            hostName,
            shakeCount,
            remainingShakes: shakeCount,
            mode,
            denominations: gameState.denominations,
            specialPrizes: gameState.specialPrizes,
            gameStarted: false,
            roomStatus: 'idle',
            createdAt: Date.now(),
            players: {},
            recentActivity: {}
        });
    } catch (err) {
        console.error('üî• Firebase write error:', err);
        alert('‚ùå L·ªói ghi Firebase: ' + err.message);
        if (createBtn) {
            createBtn.disabled = false;
            createBtn.textContent = 'üéä T·∫†O PH√íNG';
        }
        return;
    }

    navigateTo('admin');

    const displayElements = [
        document.getElementById('room-code-display'),
        document.getElementById('room-code-display-2')
    ];
    
    displayElements.forEach(el => {
        if (el) el.textContent = roomCode;
    });

    listenPlayersRealtime();
    
    if (createBtn) {
        createBtn.disabled = false;
        createBtn.textContent = 'üéä T·∫†O PH√íNG';
    }
}

async function joinRoom() {
    const roomCode = document.getElementById('join-room-code').value.trim().toUpperCase();

    if (!roomCode) {
        alert('Vui l√≤ng nh·∫≠p m√£ ph√≤ng!');
        return;
    }

    const joinBtn = document.querySelector('#screen-join-room .btn-primary');
    if (joinBtn) {
        joinBtn.disabled = true;
        joinBtn.textContent = '‚è≥ ƒêang ki·ªÉm tra...';
    }

    const { database, ref, get } = window.firebaseDB;

    try {
        const roomSnap = await get(ref(database, `rooms/${roomCode}`));

        if (!roomSnap.exists()) {
            alert('‚ùå Ph√≤ng kh√¥ng t·ªìn t·∫°i');
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.textContent = 'üéâ THAM GIA';
            }
            return;
        }

        const roomData = roomSnap.val();

        if (roomData.gameStarted) {
            alert('‚ùå Ph√≤ng ƒë√£ b·∫Øt ƒë·∫ßu, kh√¥ng th·ªÉ tham gia!');
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.textContent = 'üéâ THAM GIA';
            }
            return;
        }

        clearGameState();
        
        gameState.denominations = roomData.denominations || {};
        gameState.specialPrizes = roomData.specialPrizes || {};
        gameState.denominationsBackup = JSON.parse(JSON.stringify(gameState.denominations));
        gameState.specialPrizesBackup = JSON.parse(JSON.stringify(gameState.specialPrizes));
        gameState.roomCode = roomCode;
        gameState.playerRoomCode = roomCode;
        gameState.isHost = false;

        saveGameState();
        navigateTo('enter-name');

    } catch (err) {
        console.error('üî• Firebase error:', err);
        alert('‚ùå L·ªói ki·ªÉm tra ph√≤ng: ' + err.message);
        if (joinBtn) {
            joinBtn.disabled = false;
            joinBtn.textContent = 'üéâ THAM GIA';
        }
    }
}

async function submitPlayerName() {
    const playerName = document.getElementById('player-name').value.trim();
    
    if (!playerName) {
        alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
        return;
    }

    const submitBtn = document.querySelector('#screen-enter-name .btn-primary');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ ƒêang tham gia...';
    }

    const { database, ref, push, set, get } = window.firebaseDB;

    try {
        const roomSnap = await get(ref(database, `rooms/${gameState.roomCode}`));
        if (roomSnap.exists() && roomSnap.val().gameStarted) {
            alert('‚ùå Ph√≤ng ƒë√£ b·∫Øt ƒë·∫ßu, kh√¥ng th·ªÉ tham gia!');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ X√ÅC NH·∫¨N';
            }
            navigateTo('home', true);
            return;
        }
    } catch (err) {
        console.error('Error checking room:', err);
    }

    gameState.currentPlayer = playerName;
    saveGameState();

    try {
        const playerRef = push(ref(database, `rooms/${gameState.roomCode}/players`));

        await set(playerRef, {
            name: playerName,
            joinedAt: Date.now(),
            status: 'waiting'
        });
        
        listenPlayersRealtime();
        listenRoomStatus();
        navigateTo('welcome');
        const welcomeNameEl = document.getElementById('welcome-name');
        if (welcomeNameEl) welcomeNameEl.textContent = playerName;

    } catch (err) {
        console.error('üî• Firebase error:', err);
        alert('‚ùå L·ªói tham gia ph√≤ng: ' + err.message);
        
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '‚úÖ X√ÅC NH·∫¨N';
        }
    }
}

async function startGame() {
    if (!gameState.roomCode) return;

    const { database, ref, update } = window.firebaseDB;

    try {
        await update(ref(database, `rooms/${gameState.roomCode}`), {
            gameStarted: true,
            roomStatus: 'active',
            startedAt: Date.now()
        });

        gameState.gameStarted = true;
        gameState.roomStatus = 'active';
        saveGameState();

        navigateTo('host-after-start', true);
    } catch (e) {
        console.error('Start game error:', e);
        alert('‚ùå Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu game');
    }
}

function hostJoinGame() {
    gameState.currentPlayer = gameState.hostName;
    gameState.remainingShakes = gameState.shakeCount;
    saveGameState();
    navigateTo('shake');
    const remainingEl = document.getElementById('remaining-shakes');
    if (remainingEl) remainingEl.textContent = gameState.remainingShakes;
}

function confirmBackFromStarted() {
    const choice = confirm(
        'üîô B·∫°n mu·ªën quay l·∫°i?\n\n' +
        '‚úÖ OK = L∆∞u ph√≤ng v√† v·ªÅ trang ch·ªß\n' +
        '‚ùå Cancel = ·ªû l·∫°i m√†n h√¨nh n√†y'
    );
    
    if (choice) {
        saveGameState();
        navigateTo('home', true);
    }
}

async function closeRoom() {
    if (!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën H·ª¶Y PH√íNG?\n\nPh√≤ng s·∫Ω b·ªã x√≥a ho√†n to√†n v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!')) return;
    
    const { database, ref, remove } = window.firebaseDB;
    
    try {
        await remove(ref(database, `rooms/${gameState.roomCode}`));
        
        clearGameState();
        
        alert('‚úÖ ƒê√£ h·ªßy ph√≤ng th√†nh c√¥ng');
        navigateTo('home', true);
    } catch (e) {
        console.error('Error closing room:', e);
        alert('‚ùå Kh√¥ng th·ªÉ h·ªßy ph√≤ng');
    }
}

function injectCancelButton() {
    const observeScreen = document.getElementById('screen-host-observe');
    if (!observeScreen) return;
    
    const shareBtn = Array.from(observeScreen.querySelectorAll('.btn')).find(btn => 
        btn.textContent.includes('M·ªúI TH√äM B·∫†N') || btn.textContent.includes('M·ªúI B·∫†N')
    );
    
    if (!shareBtn) return;
    
    if (observeScreen.querySelector('.cancel-room-btn')) return;
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn cancel-room-btn';
    cancelBtn.style.cssText = 'background: #FF5722; color: white; margin-top: 12px;';
    cancelBtn.innerHTML = 'üóëÔ∏è H·ª¶Y PH√íNG';
    cancelBtn.onclick = closeRoom;
    
    shareBtn.parentNode.insertBefore(cancelBtn, shareBtn.nextSibling);
}

function injectStartedBackButton() {
    const startedScreen = document.getElementById('screen-started');
    if (!startedScreen) return;
    
    if (startedScreen.querySelector('.back-btn')) return;
    
    const backBtn = document.createElement('button');
    backBtn.className = 'back-btn';
    backBtn.innerHTML = '‚Üê';
    backBtn.onclick = confirmBackFromStarted;
    
    startedScreen.insertBefore(backBtn, startedScreen.firstChild);
}

function updateRoomStatus() {
    const statusEl = document.getElementById('room-status-indicator');
    if (!statusEl) return;
    
    let statusHTML = '';
    
    if (!gameState.gameStarted) {
        statusHTML = '<div style="background: #FFC107; color: white; padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700;"><span>‚è∏Ô∏è</span> Ch∆∞a b·∫Øt ƒë·∫ßu</div>';
    } else if (gameState.roomStatus === 'active') {
        statusHTML = '<div style="background: #4CAF50; color: white; padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700;"><span>‚ñ∂Ô∏è</span> ƒêang di·ªÖn ra</div>';
    } else if (gameState.roomStatus === 'closed') {
        statusHTML = '<div style="background: #9E9E9E; color: white; padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700;"><span>‚èπÔ∏è</span> ƒê√£ k·∫øt th√∫c</div>';
    }
    
    statusEl.innerHTML = statusHTML;
}

function listenRoomStatus() {
    if (!gameState.playerRoomCode || gameState.isHost) return;
    
    const { database, ref, onValue } = window.firebaseDB;
    
    // Detach old listener
    if (roomStatusListener) {
        roomStatusListener();
    }
    
    const roomRef = ref(database, `rooms/${gameState.playerRoomCode}`);
    
    const unsubscribe = onValue(roomRef, (snapshot) => {
        if (!snapshot.exists()) {
            alert('üö´ Ph√≤ng ƒë√£ b·ªã h·ªßy b·ªüi ch·ªß ph√≤ng');
            clearGameState();
            navigateTo('home', true);
        }
    });
    
    roomStatusListener = unsubscribe;
}

// ========== 9. PLAYER MANAGEMENT ==========
function listenPlayersRealtime() {
    if (playersListenerStarted && playersListenerRoom === gameState.roomCode) return;

    playersListenerStarted = true;
    playersListenerRoom = gameState.roomCode;

    const { database, ref, onValue } = window.firebaseDB;

    onValue(ref(database, `rooms/${gameState.roomCode}/players`), (snapshot) => {
        const data = snapshot.val();
        gameState.players = data ? Object.values(data) : [];
        updatePlayerList();
        updateWaitingPlayerList();
    });

    onValue(ref(database, `rooms/${gameState.roomCode}/gameStarted`), (snapshot) => {
        const started = snapshot.val();
        if (started && !gameState.isHost) {
            gameState.gameStarted = true;
            saveGameState();
            navigateTo('started', true);
        }
    });

    onValue(ref(database, `rooms/${gameState.roomCode}/recentActivity`), (snapshot) => {
        const data = snapshot.val();
        if (!data) {
            gameState.recentActivity = [];
        } else {
            gameState.recentActivity = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
        }
        updateRecentActivityList();
    });
    
    onValue(ref(database, `rooms/${gameState.roomCode}/roomStatus`), (snapshot) => {
        const status = snapshot.val();
        if (status) {
            gameState.roomStatus = status;
            updateRoomStatus();
        }
    });
}

async function updatePlayerInFirebase(playerName, data) {
    const { database, ref, get, update } = window.firebaseDB;

    const playersRef = ref(database, `rooms/${gameState.roomCode}/players`);
    const snap = await get(playersRef);
    if (!snap.exists()) return;

    const players = snap.val();

    for (const key in players) {
        if (players[key].name === playerName) {
            await update(ref(database, `rooms/${gameState.roomCode}/players/${key}`), data);
            break;
        }
    }
}

function updatePlayerList() {
    const container = document.getElementById('player-list');
    const countEl = document.getElementById('player-count');

    if (!container || !countEl) return;

    container.innerHTML = '';

    if (!gameState.players || gameState.players.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <div class="empty-state-text">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o</div>
            </div>
        `;
        countEl.textContent = '0';
        return;
    }

    gameState.players.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-item';

        let statusClass = '';
        let statusText = '';
        let statusIcon = '';
        
        if (player.status === 'claimed') {
            statusClass = '';
            statusText = 'ƒê√£ nh·∫≠n';
            statusIcon = '‚úÖ';
        } else if (player.status === 'playing') {
            statusClass = 'playing';
            statusText = 'ƒêang ch∆°i';
            statusIcon = 'üéÆ';
        } else {
            statusClass = 'waiting';
            statusText = 'ƒêang ch·ªù';
            statusIcon = '‚è≥';
        }

        item.innerHTML = `
            <div class="player-avatar">${player.name.charAt(0).toUpperCase()}</div>
            <div class="player-name">${escapeHtml(player.name)}</div>
            <div class="player-status ${statusClass}">${statusIcon} ${statusText}</div>
        `;

        container.appendChild(item);
    });

    countEl.textContent = gameState.players.length.toString();
}

function updateWaitingPlayerList() {
    const container = document.getElementById('waiting-player-list');
    if (!container) return;
    
    container.innerHTML = '';

    const playingPlayers = gameState.players.filter(p => p.status === 'waiting');

    if (playingPlayers.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üéÆ</div>
                <div class="empty-state-text">Kh√¥ng c√≥ ng∆∞·ªùi ƒëang ch∆°i</div>
            </div>
        `;
        const countEl = document.getElementById('waiting-player-count');
        if (countEl) countEl.textContent = '0';
        return;
    }

    playingPlayers.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-item';

        item.innerHTML = `
            <div class="player-avatar">${player.name.charAt(0).toUpperCase()}</div>
            <div class="player-name">${escapeHtml(player.name)}</div>
            <div class="player-status playing">üéÆ ƒêang ch∆°i</div>
        `;

        container.appendChild(item);
    });

    const countEl = document.getElementById('waiting-player-count');
    if (countEl) countEl.textContent = playingPlayers.length;
}

function updateRecentActivityList() {
    const container = document.getElementById('recent-activity-list');
    if (!container) return;
    
    container.innerHTML = '';

    if (!gameState.recentActivity || gameState.recentActivity.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üéÅ</div>
                <div class="empty-state-text">Ch∆∞a c√≥ ai r√∫t l√¨ x√¨</div>
            </div>
        `;
        return;
    }

    gameState.recentActivity.slice(0, 10).forEach(activity => {
        const item = document.createElement('div');
        item.className = 'activity-item';

        const time = new Date(activity.timestamp).toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const isSpecial = activity.prizeType === 'special';

        item.innerHTML = `
            <div class="activity-time">${time}</div>
            <div class="activity-content">
                <div class="activity-player">
                    üë§ ${escapeHtml(activity.name)}
                    <span class="activity-badge new">M·ªöI</span>
                </div>
                <div class="activity-prize ${isSpecial ? 'special' : ''}">
                    ${isSpecial ? 'üéÅ' : 'üí∞'} ${escapeHtml(activity.prize)}
                </div>
            </div>
        `;

        container.appendChild(item);
    });
}

function updatePrizeInventory() {
    const container = document.getElementById('prize-inventory');
    if (!container) return;

    container.innerHTML = '';

    if (!gameState.denominationsBackup || Object.keys(gameState.denominationsBackup).length === 0) {
        gameState.denominationsBackup = JSON.parse(JSON.stringify(gameState.denominations));
    }

    if (!gameState.specialPrizesBackup || Object.keys(gameState.specialPrizesBackup).length === 0) {
        gameState.specialPrizesBackup = JSON.parse(JSON.stringify(gameState.specialPrizes));
    }
    
    const allMoneyPrizes = new Set([
        ...Object.keys(gameState.denominations),
        ...Object.keys(gameState.denominationsBackup)
    ]);
    
    for (const denom of allMoneyPrizes) {
        const qty = gameState.denominations[denom] || 0;
        const total = gameState.denominationsBackup[denom] || qty;
        const claimed = total - qty;
        
        const item = document.createElement('div');
        item.className = 'prize-item';
        item.innerHTML = `
            <div class="prize-value">üí∞ ${escapeHtml(denom)}</div>
            <div class="prize-count ${claimed > 0 ? 'claimed' : ''}">${claimed} / ${total}</div>
        `;
        container.appendChild(item);
    }
    
    const allSpecialPrizes = new Set([
        ...Object.keys(gameState.specialPrizes),
        ...Object.keys(gameState.specialPrizesBackup)
    ]);
    
    for (const prize of allSpecialPrizes) {
        const qty = gameState.specialPrizes[prize] || 0;
        const total = gameState.specialPrizesBackup[prize] || qty;
        const claimed = total - qty;
        
        const item = document.createElement('div');
        item.className = 'prize-item special';
        item.innerHTML = `
            <div class="prize-value">
                üéÅ ${escapeHtml(prize)}
                <span class="prize-type-badge">Kh√°c</span>
            </div>
            <div class="prize-count ${claimed > 0 ? 'claimed' : ''}">${claimed} / ${total}</div>
        `;
        container.appendChild(item);
    }
}

// ========== 10. SHAKE & PRIZE ==========
function startShaking() {
    if (gameState.isShaking) return;
    
    gameState.isShaking = true;
    shakeStartTime = Date.now();
    const envelope = document.getElementById('envelope');
    if (envelope) envelope.classList.add('shaking');
    const shakeText = document.getElementById('shake-text');
    if (shakeText) shakeText.textContent = 'üéä ƒêang l·∫Øc...';

    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener('devicemotion', handleShake);
                } else {
                    shakeTimeout = setTimeout(() => stopShaking(), 3000);
                }
            })
            .catch(console.error);
    } else if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', handleShake);
    } else {
        shakeTimeout = setTimeout(() => stopShaking(), 3000);
    }

    shakeTimeout = setTimeout(() => stopShaking(), 5000);
}

function handleShake(event) {
    const acceleration = event.accelerationIncludingGravity;
    if (!acceleration) return;
    
    const threshold = 12;
    const totalAcceleration = Math.sqrt(
        Math.pow(acceleration.x || 0, 2) +
        Math.pow(acceleration.y || 0, 2) +
        Math.pow(acceleration.z || 0, 2)
    );
    
    if (totalAcceleration > threshold) {
        if (gameState.isShaking && Date.now() - shakeStartTime > 500) {
            clearTimeout(shakeTimeout);
            setTimeout(() => stopShaking(), 500);
        }
    }
}

function stopShaking() {
    gameState.isShaking = false;
    const envelope = document.getElementById('envelope');
    if (envelope) envelope.classList.remove('shaking');
    window.removeEventListener('devicemotion', handleShake);
    clearTimeout(shakeTimeout);

    drawPrize();
}

async function drawPrize() {
    if (
        Object.keys(gameState.denominations).length === 0 &&
        Object.keys(gameState.specialPrizes).length === 0
    ) {
        alert('H·∫øt ph·∫ßn th∆∞·ªüng!');
        navigateTo('home', true);
        return;
    }

    const prizePool = [];

    for (const [denom, qty] of Object.entries(gameState.denominations)) {
        for (let i = 0; i < qty; i++) {
            prizePool.push({ prize: denom, prizeType: 'money' });
        }
    }

    for (const [prize, qty] of Object.entries(gameState.specialPrizes)) {
        for (let i = 0; i < qty; i++) {
            prizePool.push({ prize, prizeType: 'special' });
        }
    }

    if (prizePool.length === 0) {
        alert('H·∫øt ph·∫ßn th∆∞·ªüng!');
        navigateTo('home', true);
        return;
    }

    const randomIndex = Math.floor(Math.random() * prizePool.length);
    const { prize: randomPrize, prizeType } = prizePool[randomIndex];

    gameState.currentPrize = randomPrize;
    gameState.currentPrizeType = prizeType;

    if (prizeType === 'money') {
        gameState.denominations[randomPrize]--;
        if (gameState.denominations[randomPrize] <= 0) {
            delete gameState.denominations[randomPrize];
        }
    } else {
        gameState.specialPrizes[randomPrize]--;
        if (gameState.specialPrizes[randomPrize] <= 0) {
            delete gameState.specialPrizes[randomPrize];
        }
    }

    updatePrizeInventory();
    gameState.remainingShakes--;

    gameState.recentActivity.unshift({
        name: gameState.currentPlayer,
        prize: randomPrize,
        prizeType,
        timestamp: Date.now()
    });

    saveGameState();
    updateRecentActivityList();
    updateWaitingPlayerList();

    const { database, ref, push } = window.firebaseDB;

    try {
        await push(ref(database, `rooms/${gameState.roomCode}/recentActivity`), {
            name: gameState.currentPlayer,
            prize: randomPrize,
            prizeType,
            timestamp: Date.now()
        });

        await updatePlayerInFirebase(gameState.currentPlayer, {
            status: 'claimed',
            prize: randomPrize,
            prizeType,
            claimedAt: Date.now()
        });
    } catch (err) {
        console.error('Error updating Firebase:', err);
    }

    const prizeAmountEl = document.getElementById('prize-amount');
    const winnerNameEl = document.getElementById('winner-name');
    const winnerPrizeEl = document.getElementById('winner-prize');
    
    if (prizeAmountEl) {
        prizeAmountEl.textContent = randomPrize;
        if (prizeType === 'special') {
            prizeAmountEl.classList.add('special');
        } else {
            prizeAmountEl.classList.remove('special');
        }
    }
    if (winnerNameEl) winnerNameEl.textContent = gameState.currentPlayer;
    if (winnerPrizeEl) winnerPrizeEl.textContent = randomPrize;

    const actionButtons = document.getElementById('prize-action-buttons');
    if (actionButtons) {
        actionButtons.innerHTML = `
            <button class="btn btn-primary" onclick="continueShaking()">üîÑ TI·∫æP T·ª§C CH∆†I</button>
        `;
    }

    navigateTo('result');
}

function continueShaking() {
    if (gameState.remainingShakes > 0) {
        navigateTo('shake');
        const remainingEl = document.getElementById('remaining-shakes');
        if (remainingEl) remainingEl.textContent = gameState.remainingShakes;
    } else {
        alert('ƒê√£ h·∫øt l∆∞·ª£t l·∫Øc!');
        if (gameState.isHost) {
            navigateTo('host-observe');
        } else {
            navigateTo('home', true);
        }
    }
}

// ========== 11. SHARE ==========
function shareRoom() {
    const shareTitle = 'L·∫Øc L√¨ X√¨ T·∫øt 2026';
    const shareText = `M·ªùi b·∫°n tham gia ph√≤ng l√¨ x√¨ ${gameState.roomCode}`;
    const shareUrl = gameState.roomLink;
    
    if (navigator.share) {
        const shareData = {
            title: shareTitle,
            text: shareText,
            url: shareUrl
        };
        
        if (navigator.canShare && !navigator.canShare(shareData)) {
            fallbackShare(shareTitle, shareText, shareUrl);
            return;
        }
        
        navigator.share(shareData)
        .then(() => {
            console.log('‚úÖ Chia s·∫ª th√†nh c√¥ng');
        })
        .catch(err => {
            if (err.name !== 'AbortError') {
                fallbackShare(shareTitle, shareText, shareUrl);
            }
        });
    } else {
        fallbackShare(shareTitle, shareText, shareUrl);
    }
}

function fallbackShare(title, text, url) {
    const fullText = `${title}\n\n${text}\n${url}`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(fullText)
            .then(() => {
                showToast('‚úÖ ƒê√£ sao ch√©p link chia s·∫ª!');
            })
            .catch(() => {
                fallbackCopyTextArea(fullText);
            });
    } else {
        fallbackCopyTextArea(fullText);
    }
}

function fallbackCopyTextArea(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('‚úÖ ƒê√£ sao ch√©p link chia s·∫ª!');
        } else {
            showToast('‚ö†Ô∏è Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast('‚ö†Ô∏è Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i.');
    }
    
    document.body.removeChild(textArea);
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        animation: fadeInOut 2.5s ease-in-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (document.body.contains(toast)) {
            document.body.removeChild(toast);
        }
    }, 2500);
}

// ========== 12. MISC ==========
function switchTab(tabName, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    if (btn) btn.classList.add('active');

    const tab = document.getElementById('tab-' + tabName);
    if (tab) tab.classList.add('active');
}

function confirmBackToHome() {
    if (gameState.currentScreen === 'host-observe') {
        navigateTo('host-after-start');
        return;
    }
    
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t? Ph√≤ng s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i.')) {
        navigateTo('home', true);
    }
}

function confirmBackFromShake() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën quay l·∫°i?')) {
        goBack();
    }
}

function initTouchSupport() {
    try {
        const selectors = ['.btn', '.denom-btn', '.quantity-btn', '.back-btn', '.bank-option', '.upload-area', '.envelope', '.tab-btn'];
        
        selectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (element) {
                    element.style.cursor = 'pointer';
                    element.addEventListener('touchstart', function(e) {
                        // Touch support for iOS
                    }, { passive: true });
                }
            });
        });

        document.querySelectorAll('.radio-option label').forEach(label => {
            if (label) {
                label.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    const radio = this.previousElementSibling;
                    if (radio && radio.type === 'radio') {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                });
            }
        });
    } catch (e) {
        console.error('Error in initTouchSupport:', e);
    }
}

// ========== 13. INIT ==========
window.addEventListener('load', function () {
    createSparks();
    
    // ‚úÖ FIX: Load state nh∆∞ng LU√îN v·ªÅ Home
    loadGameState();

    const urlParams = new URLSearchParams(window.location.search);
    const roomFromURL = urlParams.get('room');

    // N·∫øu c√≥ m√£ ph√≤ng trong URL
    if (roomFromURL && !gameState.isHost) {
        const input = document.getElementById('join-room-code');
        if (input) input.value = roomFromURL;
        showScreen('join-room');
        initTouchSupport();
        return;
    }

    // ‚úÖ LU√îN HI·ªÜN HOME KHI V√ÄO L·∫†I WEB
    showScreen('home');
    initTouchSupport();
    
    // Inject c√°c button c·∫ßn thi·∫øt
    setTimeout(() => {
        injectCancelButton();
        injectStartedBackButton();
    }, 100);
});

</script>
</body>
</html>
