<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>üßß L·∫Øc L√¨ X√¨ T·∫øt 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --red-primary: #D4202F;
            --red-dark: #8B0000;
            --gold: #FFD700;
            --gold-light: #FFF4CC;
            --cream: #FFF8DC;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #D4202F;
            background: linear-gradient(to bottom, #D4202F 0%, #8B0000 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Fireworks background */
        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            animation: sparkle 3s infinite;
            opacity: 0;
        }

        @keyframes sparkle {
            0%, 100% { 
                opacity: 0; 
                transform: scale(0); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            15%, 85% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
        }

        /* Lanterns decoration */
        .lanterns {
            position: fixed;
            top: -50px;
            left: 0;
            width: 100%;
            height: 150px;
            pointer-events: none;
            z-index: 2;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
        }

        .lantern {
            width: 50px;
            height: 70px;
            background: #D4202F;
            border-radius: 0 0 25px 25px;
            position: relative;
            animation: swing 3s ease-in-out infinite;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .lantern:before {
            content: 'Á¶è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-size: 20px;
            font-weight: bold;
        }

        .lantern:after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 12px;
            background: #FFD700;
            border-radius: 50%;
        }

        @keyframes swing {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .lantern:nth-child(2) { animation-delay: 0.5s; }
        .lantern:nth-child(3) { animation-delay: 1s; }
        .lantern:nth-child(4) { animation-delay: 1.5s; }

        /* Container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            animation: slideDown 0.8s ease-out;
        }

        .header h1 {
            font-family: cursive;
            font-size: 42px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            color: #FFF4CC;
            font-size: 16px;
            font-weight: 600;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Back button */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-btn:hover,
        .back-btn:active {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        /* Screen container */
        .screen {
            background: white;
            border-radius: 30px;
            padding: 35px 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .screen:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #FFD700, #D4202F, #FFD700);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 50px;
            font-family: 'Quicksand', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #D4202F;
            color: white;
            box-shadow: 0 8px 20px rgba(212, 32, 47, 0.3);
            margin-bottom: 12px;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background: #8B0000;
            box-shadow: 0 12px 30px rgba(212, 32, 47, 0.4);
        }

        .btn-secondary {
            background: #FFD700;
            color: #8B0000;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .btn-secondary:hover,
        .btn-secondary:focus {
            background: #FFA500;
            box-shadow: 0 12px 30px rgba(255, 215, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Input fields */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            color: #8B0000;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #FFE4E1;
            border-radius: 15px;
            font-family: 'Quicksand', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B0000' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #D4202F;
            box-shadow: 0 0 0 3px rgba(212, 32, 47, 0.1);
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            gap: 12px;
            margin: 18px 0;
        }

        .radio-option {
            flex: 1;
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-option label {
            display: block;
            padding: 18px 15px;
            background: #FFF8DC;
            border: 2px solid transparent;
            border-radius: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            color: #8B0000;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #D4202F;
            color: white;
            border-color: #FFD700;
            transform: scale(1.03);
        }

        /* Denomination buttons */
        .denomination-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 18px 0;
        }

        .denom-btn {
            padding: 14px 10px;
            background: #FFF4CC;
            border: 2px solid #FFD700;
            border-radius: 15px;
            font-weight: 700;
            color: #8B0000;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .denom-btn:hover,
        .denom-btn:active {
            background: #FFD700;
            transform: scale(1.05);
        }

        .denom-btn.selected {
            background: #D4202F;
            color: white;
            border-color: #8B0000;
        }

        /* Selected denominations list */
        .selected-list {
            margin: 18px 0;
        }

        .selected-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .selected-item.special-prize {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .selected-item-value {
            font-weight: 700;
            color: #8B0000;
            font-size: 15px;
            flex: 1;
        }

        .selected-item-type {
            font-size: 11px;
            color: #4CAF50;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #D4202F;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .quantity-btn:hover,
        .quantity-btn:active {
            background: #8B0000;
            transform: scale(1.1);
        }

        .quantity-display {
            min-width: 30px;
            text-align: center;
            font-weight: 700;
            color: #8B0000;
        }

        /* Total budget */
        .total-budget {
            background: linear-gradient(to right, #FFD700, #FFA500);
            padding: 18px;
            border-radius: 18px;
            text-align: center;
            margin: 18px 0;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .total-budget-label {
            font-size: 13px;
            color: #8B0000;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .total-budget-amount {
            font-size: 28px;
            font-weight: 700;
            color: #8B0000;
            font-family: serif;
        }

        /* Custom prize input */
        .custom-prize-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .custom-prize-input input:first-child {
            flex: 3;
        }

        .custom-prize-input input:last-child {
            flex: 7;
        }

        /* QR Code section */
        .qr-section {
            text-align: center;
            padding: 25px 0;
        }

        .qr-code {
            width: 220px;
            margin: 18px auto;
            padding: 15px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(212, 32, 47, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #qrcode {
            display: inline-block;
            width: 180px;
            height: 180px;
        }

        #qrcode img, #qrcode canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .qr-download-btn {
            margin-top: 8px;
            padding: 4px 12px;
            background: #FFD700;
            color: #8B0000;
            border: 1px solid #FFD700;
            border-radius: 15px;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .qr-download-btn:hover,
        .qr-download-btn:active {
            background: #FFA500;
            border-color: #FFA500;
        }

        /* Share popup overlay */
        .share-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .share-popup {
            background: white;
            border-radius: 25px;
            padding: 30px 25px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .share-popup-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .share-popup-header h3 {
            color: #D4202F;
            font-size: 22px;
            margin-bottom: 10px;
        }

        .share-popup-header .emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .share-message {
            background: #FFF8DC;
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #FFD700;
        }

        .share-message p {
            color: #8B0000;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            font-weight: 600;
        }

        .share-room-code {
            background: #FFF4CC;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
        }

        .share-room-code strong {
            color: #D4202F;
            font-size: 20px;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .share-link {
            background: #E3F2FD;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 12px;
            color: #1976D2;
            text-align: center;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .share-option {
            background: #F5F5F5;
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .share-option:hover,
        .share-option:active {
            background: #FFF4CC;
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .share-option-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .share-option-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .share-popup-close {
            width: 100%;
            padding: 12px;
            background: #D4202F;
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .share-popup-close:hover,
        .share-popup-close:active {
            background: #8B0000;
        }

        .room-code {
            background: #FFF4CC;
            padding: 18px;
            border-radius: 15px;
            margin: 18px 0;
        }

        .room-code-label {
            font-size: 13px;
            color: #8B0000;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .room-code-value {
            font-size: 22px;
            font-weight: 700;
            color: #D4202F;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }

        /* Player list */
        .player-list {
            margin: 18px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #D4202F;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            font-size: 16px;
        }

        .player-name {
            flex: 1;
            font-weight: 600;
            color: #8B0000;
        }

        .player-status {
            background: #FFD700;
            padding: 5px 14px;
            border-radius: 18px;
            font-weight: 700;
            color: #8B0000;
            font-size: 13px;
        }

        .player-status.waiting {
            background: #FFE4E1;
            color: #999;
        }

        .player-prize {
            background: #FFD700;
            padding: 5px 14px;
            border-radius: 18px;
            font-weight: 700;
            color: #8B0000;
            font-size: 13px;
        }

        .player-prize.special {
            background: #4CAF50;
            color: white;
        }

        /* Prize inventory */
        .prize-inventory {
            margin: 18px 0;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 8px;
        }

        .prize-item.special {
            background: #E8F5E9;
        }

        .prize-value {
            font-weight: 700;
            color: #8B0000;
            flex: 1;
        }

        .prize-type-badge {
            font-size: 10px;
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .prize-count {
            font-weight: 600;
            color: #666;
        }

        .prize-count.claimed {
            color: #D4202F;
        }

        /* Shake animation */
        .envelope-container {
            text-align: center;
            padding: 35px 0;
        }

        .envelope {
            width: 180px;
            height: 110px;
            margin: 0 auto;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .envelope.shaking {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg) translateX(0); }
            25% { transform: rotate(-8deg) translateX(-8px); }
            75% { transform: rotate(8deg) translateX(8px); }
        }

        .envelope-front {
            width: 100%;
            height: 100%;
            background: #D4202F;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 12px 35px rgba(139, 0, 0, 0.4);
        }

        .envelope-front:after {
            content: 'Á¶è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            color: #FFD700;
            font-weight: 700;
        }

        .shake-instruction {
            margin-top: 25px;
            font-size: 16px;
            color: #FFD700;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Result display */
        .result-title {
            font-family: cursive;
            font-size: 38px;
            color: #D4202F;
            margin-bottom: 18px;
        }

        .result-prize {
            font-size: 56px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin: 18px 0;
            font-family: serif;
        }

        .result-prize.special {
            font-size: 32px;
            color: #4CAF50;
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 35px;
        }

        .spinner {
            width: 55px;
            height: 55px;
            margin: 0 auto 18px;
            border: 4px solid #FFF4CC;
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #8B0000;
            font-weight: 600;
            font-size: 15px;
        }

        /* Waiting screen */
        .waiting-screen {
            text-align: center;
            padding: 35px 0;
        }

        .waiting-icon {
            font-size: 72px;
            margin: 25px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-18px); }
        }

        .waiting-message {
            font-size: 16px;
            color: #8B0000;
            font-weight: 600;
            margin: 18px 0;
        }

        /* Status badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #4CAF50;
            color: white;
            padding: 12px 22px;
            border-radius: 28px;
            font-weight: 700;
            margin: 18px 0;
            animation: fadeIn 0.5s;
        }

        .status-badge:before {
            content: '‚úì';
            font-size: 18px;
        }

        /* Bank info form */
        .bank-options {
            margin: 18px 0;
        }

        .bank-option {
            border: 2px solid #FFE4E1;
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .bank-option:hover,
        .bank-option:active {
            border-color: #D4202F;
            background: #FFF8DC;
        }

        .bank-option.selected {
            border-color: #D4202F;
            background: #FFF4CC;
        }

        .bank-option h3 {
            color: #8B0000;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .bank-option p {
            color: #666;
            font-size: 13px;
            margin: 0;
        }

        .upload-area {
            border: 3px dashed #FFD700;
            border-radius: 18px;
            padding: 35px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 18px 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .upload-area:hover,
        .upload-area:active {
            border-color: #D4202F;
            background: #FFF4CC;
        }

        .upload-icon {
            font-size: 44px;
            margin-bottom: 14px;
        }

        /* Activity item */
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 14px;
            background: #FFF8DC;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .activity-time {
            font-size: 11px;
            color: #999;
            margin-right: 12px;
            white-space: nowrap;
            min-width: 50px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-player {
            font-weight: 700;
            color: #8B0000;
            margin-bottom: 4px;
        }

        .activity-prize {
            font-size: 13px;
            color: #D4202F;
            font-weight: 600;
        }

        .activity-prize.special {
            color: #4CAF50;
        }

        .activity-badge {
            background: #FFD700;
            color: #8B0000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .activity-badge.new {
            background: #4CAF50;
            color: white;
        }

        /* Tab navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin: 18px 0;
            background: #FFF4CC;
            border-radius: 15px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 12px;
            font-family: 'Quicksand', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #8B0000;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn.active {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 34px;
            }

            .denomination-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .radio-group {
                flex-direction: column;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        h2 {
            color: #8B0000;
            margin-bottom: 22px;
            text-align: center;
            font-size: 22px;
        }

        h3 {
            color: #8B0000;
            margin: 22px 0 14px;
            font-size: 16px;
        }
    </style>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <!-- Decorative elements -->
    <div class="fireworks" id="fireworks"></div>
    <div class="lanterns">
        <div class="lantern"></div>
        <div class="lantern"></div>
        <div class="lantern"></div>
        <div class="lantern"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üßß L·∫Øc L√¨ X√¨ T·∫øt 2026</h1>
            <p>V·∫°n s·ª± nh∆∞ √Ω - Ph√°t t√†i ph√°t l·ªôc</p>
        </div>

        <!-- Screen 1: Home -->
        <div id="screen-home" class="screen">
            <h2>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi tr√≤ ch∆°i l√¨ x√¨!</h2>
            <button class="btn btn-primary" onclick="navigateTo('create-room')">üéä T·∫†O PH√íNG</button>
            <button class="btn btn-secondary" onclick="navigateTo('join-room')">üéâ THAM GIA PH√íNG</button>
            
            <!-- Clear data button -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="resetApp()" style="background: none; border: none; color: #FFF4CC; font-size: 12px; cursor: pointer; text-decoration: underline; opacity: 0.7;">
                    üîÑ X√≥a d·ªØ li·ªáu & l√†m m·ªõi
                </button>
            </div>
        </div>

        <!-- Screen 2: Create Room -->
        <div id="screen-create-room" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>T·∫°o Ph√≤ng M·ªõi</h2>
            
            <div class="form-group">
                <label>üë§ T√™n ch·ªß ph√≤ng</label>
                <input type="text" id="host-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            </div>

            <div class="form-group">
                <label>üé≤ S·ªë l∆∞·ª£t l·∫Øc</label>
                <input type="number" id="shake-count" placeholder="Nh·∫≠p s·ªë l∆∞·ª£t" min="1" value="10">
            </div>

            <div class="form-group">
                <label>üéÆ Ch·∫ø ƒë·ªô ch∆°i</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" name="mode" id="mode-online" value="online" checked>
                        <label for="mode-online">
                            üåê<br>Online<br>
                            <small style="font-size: 11px; font-weight: 400;">QR/M√£ ph√≤ng</small>
                        </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="mode" id="mode-local" value="local">
                        <label for="mode-local">
                            üì±<br>Local<br>
                            <small style="font-size: 11px; font-weight: 400;">Truy·ªÅn tay</small>
                        </label>
                    </div>
                </div>
            </div>

            <h3>üí∞ C·∫•u h√¨nh ph·∫ßn th∆∞·ªüng ti·ªÅn</h3>
            
            <div class="denomination-grid">
                <button class="denom-btn" onclick="selectDenom('20K')">20K</button>
                <button class="denom-btn" onclick="selectDenom('50K')">50K</button>
                <button class="denom-btn" onclick="selectDenom('100K')">100K</button>
                <button class="denom-btn" onclick="selectDenom('200K')">200K</button>
                <button class="denom-btn" onclick="selectDenom('500K')">500K</button>
                <button class="denom-btn" onclick="addCustomDenom()">‚ûï Th√™m</button>
            </div>

            <h3>üéÅ Ph·∫ßn th∆∞·ªüng kh√°c (kh√¥ng t√≠nh ng√¢n s√°ch)</h3>
            <div id="special-prizes-container"></div>
            <button class="btn btn-secondary" onclick="addSpecialPrize()" style="font-size: 14px; padding: 12px;">
                ‚ûï Th√™m ph·∫ßn th∆∞·ªüng kh√°c
            </button>

            <div id="selected-denoms" class="selected-list"></div>

            <div class="total-budget">
                <div class="total-budget-label">T·ªïng ng√¢n s√°ch (ch·ªâ ti·ªÅn)</div>
                <div class="total-budget-amount" id="total-budget">0ƒë</div>
            </div>

            <button class="btn btn-primary" onclick="createRoom()">üéä T·∫†O PH√íNG</button>
        </div>

        <!-- Screen 3: Join Room -->
        <div id="screen-join-room" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>Tham Gia Ph√≤ng</h2>
            
            <div class="form-group">
                <label>üîë M√£ ph√≤ng</label>
                <input type="text" id="join-room-code" placeholder="Nh·∫≠p m√£ ph√≤ng" style="text-transform: uppercase;">
            </div>

            <button class="btn btn-primary" onclick="joinRoom()">üéâ THAM GIA</button>

            <div style="text-align: center; margin: 28px 0; padding: 18px; background: #FFF4CC; border-radius: 15px;">
                <p style="color: #8B0000; font-size: 13px; margin-bottom: 10px;">Ho·∫∑c qu√©t m√£ QR t·ª´ ch·ªß ph√≤ng</p>
                <div style="font-size: 44px;">üì∑</div>
                <p style="color: #666; font-size: 12px; margin-top: 10px;">S·ª≠ d·ª•ng ·ª©ng d·ª•ng camera ƒë·ªÉ qu√©t QR</p>
            </div>
        </div>

        <!-- Screen 4: Enter Name -->
        <div id="screen-enter-name" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>Th√¥ng tin ng∆∞·ªùi ch∆°i</h2>
            
            <div class="form-group">
                <label>üë§ T√™n c·ªßa b·∫°n</label>
                <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            </div>

            <button class="btn btn-primary" onclick="submitPlayerName()">‚úÖ X√ÅC NH·∫¨N</button>
        </div>

        <!-- Screen 5: Welcome -->
        <div id="screen-welcome" class="screen hidden">
            <div style="text-align: center; padding: 35px 0;">
                <div style="font-size: 72px; margin-bottom: 18px;">üéä</div>
                <h2 style="font-size: 28px; margin-bottom: 14px;">Xin ch√†o,</h2>
                <h3 id="welcome-name" style="color: #D4202F; font-size: 32px; font-family: cursive; text-align: center; margin: 0;">Ng∆∞·ªùi ch∆°i</h3>
                <p style="color: #666; margin-top: 18px; font-size: 15px;">Ch√∫c b·∫°n may m·∫Øn!</p>
            </div>
            <button class="btn btn-primary" onclick="navigateTo('waiting')">üéØ TI·∫æP T·ª§C</button>
        </div>

        <!-- Screen 6: Admin Dashboard -->
        <div id="screen-admin" class="screen hidden">
            <button class="back-btn" onclick="confirmBackToHome()">‚Üê</button>
            <h2>B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
            
            <div class="qr-section">
                <div class="qr-code">
                    <div id="qrcode"></div>
                    <button class="qr-download-btn" onclick="downloadQRCode()">üíæ L∆∞u QR</button>
                </div>
                <div class="room-code">
                    <div class="room-code-label">M√£ ph√≤ng</div>
                    <div class="room-code-value" id="room-code-display">XXXX</div>
                </div>
            </div>

            <h3>üë• Ng∆∞·ªùi tham gia (<span id="player-count">0</span>)</h3>
            <div id="player-list" class="player-list">
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <div class="empty-state-text">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o</div>
                </div>
            </div>

            <h3>üéÅ Kho ph·∫ßn th∆∞·ªüng</h3>
            <div id="prize-inventory" class="prize-inventory"></div>

            <div style="display: flex; gap: 10px; margin-top: 28px;">
                <button class="btn btn-primary" onclick="startGame()" style="flex: 1;">üöÄ B·∫ÆT ƒê·∫¶U</button>
                <button class="btn btn-secondary" onclick="shareRoom()" style="flex: 1;">üì§ M·ªúI B·∫†N</button>
            </div>
        </div>

        <!-- Screen 6.5: Host After Start -->
        <div id="screen-host-after-start" class="screen hidden">
            <button class="back-btn" onclick="confirmBackToHome()">‚Üê</button>
            <h2>Ph√≤ng ƒë√£ b·∫Øt ƒë·∫ßu</h2>
            
            <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 64px; margin-bottom: 18px;">üéÆ</div>
                <p style="color: #8B0000; font-weight: 600; font-size: 16px;">
                    Tr√≤ ch∆°i ƒëang di·ªÖn ra
                </p>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="hostJoinGame()" style="flex: 1;">
                    üéä THAM GIA CH∆†I
                </button>
                <button class="btn btn-secondary" onclick="navigateTo('host-observe', false, true)" style="flex: 1;">
                    üëÅÔ∏è QUAN S√ÅT
                </button>
            </div>

            <div class="room-code" style="margin-top: 20px;">
                <div class="room-code-label">M√£ ph√≤ng</div>
                <div class="room-code-value" id="room-code-display-2">XXXX</div>
            </div>
        </div>

        <!-- Screen 6.6: Host Observe -->
        <div id="screen-host-observe" class="screen hidden">
            <button class="back-btn" onclick="confirmBackToHome()">‚Üê</button>
            <h2>Ph·∫ßn Quan S√°t</h2>

            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('waiting-players')">
                    ‚è≥ ƒêang ch·ªù
                </button>
                <button class="tab-btn" onclick="switchTab('recent-winners')">
                    üéÅ M·ªõi tr√∫ng
                </button>
            </div>

            <!-- Tab: Waiting Players -->
            <div id="tab-waiting-players" class="tab-content active">
                <h3>üë• Ng∆∞·ªùi ch∆°i ƒëang ch·ªù (<span id="waiting-player-count">0</span>)</h3>
                <div id="waiting-player-list" class="player-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚è≥</div>
                        <div class="empty-state-text">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o ƒëang ch·ªù</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Recent Winners -->
            <div id="tab-recent-winners" class="tab-content">
                <h3>üéä Ng∆∞·ªùi r√∫t l√¨ x√¨ g·∫ßn nh·∫•t</h3>
                <div id="recent-activity-list" class="player-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 28px;">
                <button class="btn btn-secondary" onclick="shareRoom()">üì§ M·ªúI TH√äM B·∫†N</button>
            </div>
        </div>

        <!-- Screen 7: Waiting Room -->
        <div id="screen-waiting" class="screen hidden">
            <div class="waiting-screen">
                <div class="waiting-icon">‚è≥</div>
                <h2>Ch·ªù ch·ªß ph√≤ng...</h2>
                <p class="waiting-message">T√≠ch c·ª±c l·∫Øc - v·∫≠n may s·∫Ω ƒë·∫øn! üçÄ</p>
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Screen 8: Game Started -->
        <div id="screen-started" class="screen hidden">
            <div style="text-align: center; padding: 35px 0;">
                <div style="font-size: 72px; margin-bottom: 18px;">üéâ</div>
                <div class="status-badge">ƒê√É B·∫ÆT ƒê·∫¶U</div>
                <h2 style="margin: 18px 0;">Tr√≤ ch∆°i ƒë√£ b·∫Øt ƒë·∫ßu!</h2>
                <p style="color: #666; font-size: 15px;">S·∫µn s√†ng nh·∫≠n l√¨ x√¨ th√¥i n√†o!</p>
            </div>
            <button class="btn btn-primary" onclick="navigateTo('shake')">üéä OK, B·∫ÆT ƒê·∫¶U CH∆†I!</button>
        </div>

        <!-- Screen 9: Shake -->
        <div id="screen-shake" class="screen hidden">
            <button class="back-btn" onclick="confirmBackFromShake()">‚Üê</button>
            <h2>L·∫Øc ƒë·ªÉ nh·∫≠n l√¨ x√¨!</h2>
            
            <div class="envelope-container">
                <div class="envelope" id="envelope" onclick="startShaking()">
                    <div class="envelope-front"></div>
                </div>
                <p class="shake-instruction" id="shake-text">üëÜ Ch·∫°m v√†o bao l√¨ x√¨ v√† l·∫Øc ƒëi·ªán tho·∫°i</p>
            </div>

            <div style="text-align: center; margin-top: 28px;">
                <p style="color: #FFD700; font-weight: 600; font-size: 16px;">
                    L∆∞·ª£t c√≤n l·∫°i: <span id="remaining-shakes" style="font-size: 22px; font-weight: 700;">10</span>
                </p>
            </div>
        </div>

        <!-- Screen 10: Prize Result -->
        <div id="screen-result" class="screen hidden">
            <div style="text-align: center; padding: 18px 0;">
                <div style="font-size: 88px; margin-bottom: 18px;">üéä</div>
                <h2 class="result-title">Ch√∫c m·ª´ng!</h2>
                <p style="color: #666; margin-bottom: 18px;">B·∫°n ƒë√£ tr√∫ng</p>
                <div class="result-prize" id="prize-amount">100K</div>
                
                <div style="background: #FFF4CC; padding: 18px; border-radius: 18px; margin: 28px 0;">
                    <p style="color: #8B0000; font-weight: 700; margin-bottom: 8px;">
                        üë§ <span id="winner-name">Ng∆∞·ªùi ch∆°i</span>
                    </p>
                    <p style="color: #8B0000; font-weight: 700;">
                        üéÅ <span id="winner-prize">100K</span>
                    </p>
                </div>

                <div id="prize-action-buttons">
                    <button class="btn btn-primary" onclick="navigateTo('withdraw')">üí∞ R√öT L√å X√å</button>
                    <button class="btn btn-secondary" onclick="continueShaking()">üîÑ TI·∫æP T·ª§C CH∆†I</button>
                </div>
            </div>
        </div>

        <!-- Screen 11: Withdraw Options -->
        <div id="screen-withdraw" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>R√∫t L√¨ X√¨</h2>
            
            <div class="bank-options">
                <div class="bank-option" id="option-qr" onclick="selectWithdrawOption('qr')">
                    <h3>üì∏ Upload QR Code</h3>
                    <p>Ch·ª•p/t·∫£i l√™n m√£ QR ng√¢n h√†ng c·ªßa b·∫°n</p>
                </div>

                <div class="bank-option" id="option-manual" onclick="selectWithdrawOption('manual')">
                    <h3>‚úçÔ∏è Nh·∫≠p th√¥ng tin</h3>
                    <p>ƒêi·ªÅn th√¥ng tin t√†i kho·∫£n ng√¢n h√†ng</p>
                </div>
            </div>
        </div>

        <!-- Screen 12: QR Upload -->
        <div id="screen-qr-upload" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>Upload QR Code</h2>
            
            <div class="upload-area" onclick="document.getElementById('qr-file').click()">
                <input type="file" id="qr-file" accept="image/*" style="display: none;" onchange="previewQR(event)">
                <div class="upload-icon">üì§</div>
                <p style="color: #8B0000; font-weight: 600;">Ch·∫°m ƒë·ªÉ ch·ªçn ·∫£nh QR</p>
                <p style="color: #999; font-size: 13px; margin-top: 8px;">PNG, JPG</p>
            </div>

            <div id="qr-preview" class="hidden" style="text-align: center; margin: 18px 0;">
                <img id="qr-preview-img" style="max-width: 100%; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
            </div>

            <button class="btn btn-primary" id="submit-qr-btn" onclick="submitQRCode()" disabled>‚úÖ X√ÅC NH·∫¨N</button>
        </div>

        <!-- Screen 13: Manual Bank Info -->
        <div id="screen-bank-info" class="screen hidden">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h2>Th√¥ng tin ng√¢n h√†ng</h2>
            
            <div class="form-group">
                <label>üè¶ T√™n ng√¢n h√†ng</label>
                <select id="bank-name">
                    <option value="">Ch·ªçn ng√¢n h√†ng</option>
                    <option value="Vietcombank">Vietcombank</option>
                    <option value="Techcombank">Techcombank</option>
                    <option value="BIDV">BIDV</option>
                    <option value="VietinBank">VietinBank</option>
                    <option value="ACB">ACB</option>
                    <option value="MB">MB Bank</option>
                    <option value="VPBank">VPBank</option>
                    <option value="TPBank">TPBank</option>
                    <option value="Sacombank">Sacombank</option>
                    <option value="other">Ng√¢n h√†ng kh√°c</option>
                </select>
            </div>

            <div class="form-group">
                <label>üë§ T√™n t√†i kho·∫£n</label>
                <input type="text" id="account-name" placeholder="NGUYEN VAN A">
            </div>

            <div class="form-group">
                <label>üí≥ S·ªë t√†i kho·∫£n</label>
                <input type="text" id="account-number" placeholder="0123456789">
            </div>

            <button class="btn btn-primary" onclick="submitBankInfo()">‚úÖ G·ª¨I TH√îNG TIN</button>
        </div>

        <!-- Screen 14: Success -->
        <div id="screen-success" class="screen hidden">
            <div style="text-align: center; padding: 35px 0;">
                <div style="font-size: 88px; margin-bottom: 18px;">‚úÖ</div>
                <h2>Th√†nh c√¥ng!</h2>
                <p style="color: #666; font-size: 15px; margin-bottom: 28px;">
                    Th√¥ng tin c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ch·ªß ph√≤ng.<br>
                    Vui l√≤ng ch·ªù chuy·ªÉn kho·∫£n.
                </p>
                <div style="background: #FFF4CC; padding: 18px; border-radius: 18px; margin: 18px 0;">
                    <p style="color: #8B0000; font-weight: 700; font-size: 16px;">
                        üéÅ Ph·∫ßn th∆∞·ªüng: <span id="final-prize">100K</span>
                    </p>
                </div>
            </div>
            <button class="btn btn-primary" onclick="navigateTo('home', true)">üè† V·ªÄ TRANG CH·ª¶</button>
        </div>
    </div>

    <script>
// Game state
let gameState = {
    mode: 'online',
    hostName: '',
    shakeCount: 10,
    roomCode: '',
    roomLink: '',
    denominations: {},
    specialPrizes: {},
    denominationsBackup: {},
    specialPrizesBackup: {},
    players: [],
    waitingPlayers: [],
    winners: [],
    recentActivity: [],
    currentPlayer: '',
    currentPrize: '',
    currentPrizeType: 'money',
    isShaking: false,
    remainingShakes: 10,
    currentScreen: 'home',
    isHost: false,
    gameStarted: false
};

const STORAGE_KEY = 'tet_lixi_game_state';
let navigationHistory = ['home'];
let specialPrizeCounter = 0;

// Generate sparks for fireworks
function createSparks() {
    const fireworks = document.getElementById('fireworks');
    for (let i = 0; i < 30; i++) {
        const spark = document.createElement('div');
        spark.className = 'spark';
        spark.style.left = Math.random() * 100 + '%';
        spark.style.top = Math.random() * 100 + '%';
        spark.style.animationDelay = Math.random() * 3 + 's';
        fireworks.appendChild(spark);
    }
}
createSparks();

// Navigation
function navigateTo(screenId, clearHistory = false, replaceHistory = false) {
    if (clearHistory) {
        navigationHistory = [screenId];
    } else if (replaceHistory) {
        // Thay th·∫ø m√†n h√¨nh hi·ªán t·∫°i thay v√¨ th√™m m·ªõi
        navigationHistory[navigationHistory.length - 1] = screenId;
    } else {
        navigationHistory.push(screenId);
    }
    
    gameState.currentScreen = screenId;
    saveGameState();
    showScreen(screenId);
    
    if (replaceHistory) {
        history.replaceState({ screen: screenId }, '', '#' + screenId);
    } else {
        history.pushState({ screen: screenId }, '', '#' + screenId);
    }
}

function goBack() {
    if (navigationHistory.length > 1) {
        navigationHistory.pop();
        const previousScreen = navigationHistory[navigationHistory.length - 1];
        gameState.currentScreen = previousScreen;
        saveGameState();
        showScreen(previousScreen);
    } else {
        navigateTo('home', true);
    }
}

window.addEventListener('popstate', function(event) {
    goBack();
});

// Storage functions
function saveGameState() {
    try {
        gameState.savedTime = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
    } catch (e) {
        console.error('Error saving:', e);
    }
}

function loadGameState() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const loaded = JSON.parse(saved);
            
            if (!loaded || typeof loaded !== 'object') {
                clearGameState();
                return;
            }
            
            const savedTime = loaded.savedTime || 0;
            const currentTime = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            if (currentTime - savedTime > twentyFourHours) {
                clearGameState();
                return;
            }
            
            Object.assign(gameState, loaded);
            
            if (gameState.isHost && gameState.roomCode) {
                try {
                    restoreAdminDashboard();
                } catch (e) {
                    clearGameState();
                    showScreen('home');
                    return;
                }
            }
            
            if (gameState.denominations && Object.keys(gameState.denominations).length > 0) {
                try {
                    updateDenomList();
                } catch (e) {
                    console.error('Error updating denom list:', e);
                }
            }
            
            if (gameState.currentScreen && gameState.currentScreen !== 'home') {
                const screenElement = document.getElementById('screen-' + gameState.currentScreen);
                if (screenElement) {
                    showScreen(gameState.currentScreen);
                } else {
                    showScreen('home');
                }
            }
        }
    } catch (e) {
        console.error('Error loading:', e);
        clearGameState();
        showScreen('home');
    }
}

function clearGameState() {
    try {
        localStorage.removeItem(STORAGE_KEY);
    } catch (e) {
        console.error('Error clearing:', e);
    }
}

function resetApp() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu v√† l√†m m·ªõi ·ª©ng d·ª•ng?')) {
        clearGameState();
        sessionStorage.clear();
        window.location.href = window.location.pathname;
    }
}

function restoreAdminDashboard() {
    try {
        if (!gameState.roomCode || !gameState.roomLink) {
            throw new Error('Missing room data');
        }
        
        document.getElementById('room-code-display').textContent = gameState.roomCode;
        document.getElementById('room-code-display-2').textContent = gameState.roomCode;
        
        const qrcodeElement = document.getElementById('qrcode');
        if (!qrcodeElement) {
            throw new Error('QR code element not found');
        }
        
        qrcodeElement.innerHTML = '';
        new QRCode(qrcodeElement, {
            text: gameState.roomLink,
            width: 180,
            height: 180,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        // Convert canvas to img after a short delay
        setTimeout(() => {
            convertQRCanvasToImage();
        }, 100);
        
        updatePlayerList();
        updatePrizeInventory();
        updateWaitingPlayerList();
        updateRecentActivityList();
    } catch (e) {
        console.error('Error restoring dashboard:', e);
        throw e;
    }
}

// Screen navigation
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.add('hidden');
    });
    const targetScreen = document.getElementById('screen-' + screenId);
    if (targetScreen) {
        targetScreen.classList.remove('hidden');
    }
    
    setTimeout(() => initTouchSupport(), 100);
}

// Denomination selection
function selectDenom(value) {
    if (!gameState.denominations[value]) {
        gameState.denominations[value] = 1;
    } else {
        gameState.denominations[value]++;
    }
    updateDenomList();
}

function addCustomDenom() {
    const value = prompt('Nh·∫≠p gi√° tr·ªã (v√≠ d·ª•: 1000):');
    if (value && !isNaN(value)) {
        const key = parseInt(value) >= 1000 ? (parseInt(value) / 1000) + 'K' : value + 'ƒë';
        gameState.denominations[key] = 1;
        updateDenomList();
    }
}

// Special prizes management
function addSpecialPrize() {
    specialPrizeCounter++;
    const container = document.getElementById('special-prizes-container');
    const id = 'special-' + specialPrizeCounter;
    
    const prizeDiv = document.createElement('div');
    prizeDiv.className = 'custom-prize-input';
    prizeDiv.id = id;
    prizeDiv.innerHTML = `
        <input type="text" placeholder="Lo·∫°i (vd: H√¨nh ph·∫°t)" id="${id}-type">
        <input type="text" placeholder="N·ªôi dung (vd: U·ªëng 1 ly)" id="${id}-content">
        <input type="number" placeholder="S·ªë l·∫ßn" value="1" min="1" style="width: 70px;" id="${id}-count">
        <button onclick="removeSpecialPrize('${id}')" style="background: #D4202F; color: white; border: none; border-radius: 10px; padding: 14px; cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
    `;
    
    container.appendChild(prizeDiv);
}

function removeSpecialPrize(id) {
    const element = document.getElementById(id);
    if (element) {
        element.remove();
    }
}

function collectSpecialPrizes() {
    const container = document.getElementById('special-prizes-container');
    const inputs = container.querySelectorAll('.custom-prize-input');
    
    gameState.specialPrizes = {};
    
    inputs.forEach(input => {
        const id = input.id;
        const typeInput = document.getElementById(id + '-type');
        const contentInput = document.getElementById(id + '-content');
        const countInput = document.getElementById(id + '-count');
        
        if (typeInput && contentInput && countInput) {
            const type = typeInput.value.trim();
            const content = contentInput.value.trim();
            const count = parseInt(countInput.value) || 1;
            
            if (type && content) {
                const key = type + ': ' + content;
                gameState.specialPrizes[key] = count;
            }
        }
    });
}

function updateQuantity(denom, delta) {
    gameState.denominations[denom] += delta;
    if (gameState.denominations[denom] <= 0) {
        delete gameState.denominations[denom];
    }
    updateDenomList();
}

function updateSpecialQuantity(prize, delta) {
    gameState.specialPrizes[prize] += delta;
    if (gameState.specialPrizes[prize] <= 0) {
        delete gameState.specialPrizes[prize];
    }
    updateDenomList();
}

function updateDenomList() {
    const container = document.getElementById('selected-denoms');
    container.innerHTML = '';
    
    let total = 0;
    
    // Display money prizes
    for (const [denom, qty] of Object.entries(gameState.denominations)) {
        const value = parseFloat(denom.replace(/[^0-9.]/g, ''));
        const multiplier = denom.includes('K') ? 1000 : 1;
        total += value * multiplier * qty;

        const item = document.createElement('div');
        item.className = 'selected-item';
        item.innerHTML = `
            <div class="selected-item-value">üí∞ ${denom}</div>
            <div class="quantity-control">
                <button class="quantity-btn" onclick="updateQuantity('${denom}', -1)">‚àí</button>
                <div class="quantity-display">${qty}</div>
                <button class="quantity-btn" onclick="updateQuantity('${denom}', 1)">+</button>
            </div>
        `;
        container.appendChild(item);
    }
    
    // Display special prizes
    for (const [prize, qty] of Object.entries(gameState.specialPrizes)) {
        const item = document.createElement('div');
        item.className = 'selected-item special-prize';
        item.innerHTML = `
            <div style="flex: 1;">
                <div class="selected-item-type">Ph·∫ßn th∆∞·ªüng kh√°c</div>
                <div class="selected-item-value">üéÅ ${prize}</div>
            </div>
            <div class="quantity-control">
                <button class="quantity-btn" onclick="updateSpecialQuantity('${prize.replace(/'/g, "\\'")}', -1)">‚àí</button>
                <div class="quantity-display">${qty}</div>
                <button class="quantity-btn" onclick="updateSpecialQuantity('${prize.replace(/'/g, "\\'")}', 1)">+</button>
            </div>
        `;
        container.appendChild(item);
    }

    document.getElementById('total-budget').textContent = 
        total.toLocaleString('vi-VN') + 'ƒë';
    
    saveGameState();
}

// Create room - FINAL FIX
async function createRoom() {
  const hostName = document.getElementById('host-name').value.trim();
  const shakeCount = parseInt(document.getElementById('shake-count').value);
  const mode = document.querySelector('input[name="mode"]:checked').value;

  if (!hostName) {
    alert('Vui l√≤ng nh·∫≠p t√™n ch·ªß ph√≤ng!');
    return;
  }

  collectSpecialPrizes();

  if (
    Object.keys(gameState.denominations).length === 0 &&
    Object.keys(gameState.specialPrizes).length === 0
  ) {
    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ph·∫ßn th∆∞·ªüng!');
    return;
  }

  const roomCode = generateRoomCode();

  gameState.hostName = hostName;
  gameState.shakeCount = shakeCount;
  gameState.remainingShakes = shakeCount;
  gameState.mode = mode;
  gameState.roomCode = roomCode;
  gameState.roomLink =
    location.origin + location.pathname + '?room=' + roomCode;
  gameState.isHost = true;
  gameState.gameStarted = false;

  gameState.denominationsBackup = { ...gameState.denominations };
  gameState.specialPrizesBackup = { ...gameState.specialPrizes };

  saveGameState();

  // üî• GHI FIREBASE (CH·ªà 1 L·∫¶N)
  try {
    await FirebaseHelper.createRoom(roomCode, {
      hostName,
      shakeCount,
      remainingShakes: shakeCount,
      mode,
      denominations: gameState.denominations,
      specialPrizes: gameState.specialPrizes,
      gameStarted: false
    });
  } catch (err) {
    console.error(err);
    alert('‚ùå L·ªói ghi Firebase');
    return;
  }

  navigateTo('admin');

  document.getElementById('room-code-display').textContent = roomCode;
  document.getElementById('room-code-display-2').textContent = roomCode;

  const qr = document.getElementById('qrcode');
  qr.innerHTML = '';
  new QRCode(qr, {
    text: gameState.roomLink,
    width: 180,
    height: 180
  });
}
function generateRoomCode() {
    return 'TET' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

// Download QR code
function downloadQRCode() {
    try {
        const qrcodeElement = document.getElementById('qrcode');
        
        if (!qrcodeElement) {
            alert('‚ùå Kh√¥ng t√¨m th·∫•y QR code!');
            return;
        }
        
        // QRCode.js renders to canvas, try to get canvas first
        let canvas = qrcodeElement.querySelector('canvas');
        
        if (!canvas) {
            // Fallback: try to get img element
            const img = qrcodeElement.querySelector('img');
            if (img) {
                // Convert img to canvas - use naturalWidth/Height to get original size
                canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth || img.width || 180;
                canvas.height = img.naturalHeight || img.height || 180;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            }
        }
        
        if (!canvas) {
            alert('‚ùå QR ch∆∞a s·∫µn s√†ng! Vui l√≤ng th·ª≠ l·∫°i.');
            return;
        }
        
        // Convert canvas to data URL (no padding - keep original size)
        const dataURL = canvas.toDataURL('image/png');
        
        // Detect iOS Safari
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (isIOS || isSafari) {
            // For iOS Safari: Open in new tab so user can long-press to save
            const newTab = window.open();
            if (newTab) {
                newTab.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>QR Code - M√£ ph√≤ng ${gameState.roomCode}</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                min-height: 100vh;
                                background: #f5f5f5;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            img {
                                max-width: 90%;
                                height: auto;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                border-radius: 10px;
                                background: white;
                                padding: 20px;
                            }
                            p {
                                margin-top: 20px;
                                color: #666;
                                text-align: center;
                                font-size: 14px;
                            }
                            .code {
                                font-weight: bold;
                                color: #D4202F;
                                font-size: 18px;
                                margin-top: 10px;
                            }
                        </style>
                    </head>
                    <body>
                        <img src="${dataURL}" alt="QR Code">
                        <p>M√£ ph√≤ng: <span class="code">${gameState.roomCode}</span></p>
                        <p>üì± Nh·∫•n gi·ªØ v√†o ·∫£nh ƒë·ªÉ l∆∞u v·ªÅ ƒëi·ªán tho·∫°i</p>
                    </body>
                    </html>
                `);
                newTab.document.close();
            } else {
                alert('‚ö†Ô∏è Vui l√≤ng cho ph√©p popup ƒë·ªÉ t·∫£i QR!');
            }
        } else {
            // For other browsers: Direct download
            const link = document.createElement('a');
            link.download = `QR-LiXi-${gameState.roomCode}.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('‚úÖ ƒê√£ t·∫£i QR code!');
        }
        
    } catch (error) {
        console.error('Error downloading QR:', error);
        alert('‚ùå C√≥ l·ªói khi t·∫£i QR! Vui l√≤ng th·ª≠ l·∫°i.');
    }
}

// Convert QR canvas to image for better mobile long-press support
function convertQRCanvasToImage() {
    try {
        const qrcodeElement = document.getElementById('qrcode');
        if (!qrcodeElement) return;
        
        const canvas = qrcodeElement.querySelector('canvas');
        if (!canvas) return;
        
        // Get canvas data
        const dataURL = canvas.toDataURL('image/png');
        
        // Create new img element
        const img = document.createElement('img');
        img.src = dataURL;
        img.alt = 'QR Code';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.display = 'block';
        
        // Replace canvas with img
        qrcodeElement.innerHTML = '';
        qrcodeElement.appendChild(img);
        
    } catch (error) {
        console.error('Error converting QR canvas to image:', error);
    }
}

// Join room
async function joinRoom() {
  const roomCode = document.getElementById('join-room-code').value
    .trim()
    .toUpperCase();

  if (!roomCode) {
    alert('Vui l√≤ng nh·∫≠p m√£ ph√≤ng!');
    return;
  }

  const { database, ref, get } = window.firebaseDB;

  // ‚úÖ 1. CHECK PH√íNG C√ì T·ªíN T·∫†I KH√îNG
  const roomSnap = await get(ref(database, `rooms/${roomCode}`));
  if (!roomSnap.exists()) {
    alert('‚ùå Ph√≤ng kh√¥ng t·ªìn t·∫°i');
    return;
  }

  // ‚úÖ 2. L∆ØU STATE
  gameState.roomCode = roomCode;
  gameState.isHost = false;
  saveGameState();

  // ‚úÖ 3. CHUY·ªÇN SANG NH·∫¨P T√äN
  navigateTo('enter-name');
}

async function submitPlayerName() {
  const playerName = document.getElementById('player-name').value.trim();
  if (!playerName) {
    alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
    return;
  }

  const { database, ref, push, set } = window.firebaseDB;

  gameState.currentPlayer = playerName;
  saveGameState();

  try {
    // ‚úÖ T·∫†O PLAYER TRONG FIREBASE
    const playerRef = push(ref(database, `rooms/${gameState.roomCode}/players`));

    const playerData = {
      name: playerName,
      joinedAt: Date.now(),
      status: 'waiting'
    };

    await set(playerRef, playerData);

    console.log('‚úÖ Player joined:', playerData);

    navigateTo('welcome');

  } catch (err) {
    console.error(err);
    alert('‚ùå L·ªói tham gia ph√≤ng');
  }
}

// Start game
function startGame() {
    gameState.gameStarted = true;
    saveGameState();
    // Clear history ƒë·ªÉ tr√°nh back loop
    navigateTo('host-after-start', true);
}

// Host join game
function hostJoinGame() {
    gameState.currentPlayer = gameState.hostName;
    navigateTo('shake');
    document.getElementById('remaining-shakes').textContent = gameState.remainingShakes;
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    event.target.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

// Update waiting player list
function updateWaitingPlayerList() {
    const container = document.getElementById('waiting-player-list');
    container.innerHTML = '';
    
    const waitingPlayers = gameState.players.filter(p => p.status === 'waiting');
    
    if (waitingPlayers.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <div class="empty-state-text">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o ƒëang ch·ªù</div>
            </div>
        `;
        document.getElementById('waiting-player-count').textContent = '0';
        return;
    }

    waitingPlayers.forEach(player => {
        const item = document.createElement('div');
        item.className = 'player-item';
        item.innerHTML = `
            <div class="player-avatar">${player.name.charAt(0).toUpperCase()}</div>
            <div class="player-name">${player.name}</div>
            <div class="player-status waiting">ƒêang ch·ªù</div>
        `;
        container.appendChild(item);
    });

    document.getElementById('waiting-player-count').textContent = waitingPlayers.length;
}

// Update recent activity list
function updateRecentActivityList() {
    const container = document.getElementById('recent-activity-list');
    container.innerHTML = '';
    
    if (gameState.recentActivity.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üéÅ</div>
                <div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
            </div>
        `;
        return;
    }

    gameState.recentActivity.slice(0, 10).forEach(activity => {
        const item = document.createElement('div');
        item.className = 'activity-item';
        
        const activityTime = new Date(activity.timestamp);
        const timeStr = activityTime.toLocaleTimeString('vi-VN', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const isSpecial = activity.prizeType === 'special';
        const prizeClass = isSpecial ? 'special' : '';
        
        item.innerHTML = `
            <div class="activity-time">${timeStr}</div>
            <div class="activity-content">
                <div class="activity-player">${activity.name}</div>
                <div class="activity-prize ${prizeClass}">${isSpecial ? 'üéÅ' : 'üí∞'} ${activity.prize}</div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Shake functionality
let shakeTimeout;
let shakeStartTime;

function startShaking() {
    if (gameState.isShaking) return;
    
    gameState.isShaking = true;
    shakeStartTime = Date.now();
    const envelope = document.getElementById('envelope');
    envelope.classList.add('shaking');
    document.getElementById('shake-text').textContent = 'üéä ƒêang l·∫Øc...';

    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener('devicemotion', handleShake);
                } else {
                    shakeTimeout = setTimeout(() => {
                        stopShaking();
                    }, 3000);
                }
            })
            .catch(console.error);
    } else if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', handleShake);
    } else {
        shakeTimeout = setTimeout(() => {
            stopShaking();
        }, 3000);
    }

    shakeTimeout = setTimeout(() => {
        stopShaking();
    }, 5000);
}

function handleShake(event) {
    const acceleration = event.accelerationIncludingGravity;
    if (!acceleration) return;
    
    const threshold = 12;
    
    const totalAcceleration = Math.sqrt(
        Math.pow(acceleration.x || 0, 2) +
        Math.pow(acceleration.y || 0, 2) +
        Math.pow(acceleration.z || 0, 2)
    );
    
    if (totalAcceleration > threshold) {
        if (gameState.isShaking && Date.now() - shakeStartTime > 500) {
            clearTimeout(shakeTimeout);
            setTimeout(() => stopShaking(), 500);
        }
    }
}

function stopShaking() {
    gameState.isShaking = false;
    const envelope = document.getElementById('envelope');
    envelope.classList.remove('shaking');
    window.removeEventListener('devicemotion', handleShake);
    clearTimeout(shakeTimeout);

    drawPrize();
}

function drawPrize() {
    const availablePrizes = [];
    const prizeTypes = [];
    
    // Collect money prizes
    for (const [denom, qty] of Object.entries(gameState.denominations)) {
        if (qty > 0) {
            availablePrizes.push(denom);
            prizeTypes.push('money');
        }
    }
    
    // Collect special prizes
    for (const [prize, qty] of Object.entries(gameState.specialPrizes)) {
        if (qty > 0) {
            availablePrizes.push(prize);
            prizeTypes.push('special');
        }
    }

    if (availablePrizes.length === 0) {
        alert('H·∫øt ph·∫ßn th∆∞·ªüng!');
        navigateTo('home', true);
        return;
    }

    const randomIndex = Math.floor(Math.random() * availablePrizes.length);
    const randomPrize = availablePrizes[randomIndex];
    const prizeType = prizeTypes[randomIndex];
    
    gameState.currentPrize = randomPrize;
    gameState.currentPrizeType = prizeType;
    
    // Decrease quantity
    if (prizeType === 'money') {
        gameState.denominations[randomPrize]--;
    } else {
        gameState.specialPrizes[randomPrize]--;
    }
    
    updatePrizeInventory();

    gameState.remainingShakes--;

    // Add to winners
    const winner = {
        name: gameState.currentPlayer,
        prize: randomPrize,
        prizeType: prizeType
    };
    gameState.winners.unshift(winner);
    
    // Add to recent activity
    const activity = {
        name: gameState.currentPlayer,
        prize: randomPrize,
        prizeType: prizeType,
        timestamp: new Date().toISOString()
    };
    gameState.recentActivity.unshift(activity);
    
    // Update player status
    const playerIndex = gameState.players.findIndex(p => p.name === gameState.currentPlayer);
    if (playerIndex !== -1) {
        gameState.players[playerIndex].status = 'claimed';
        gameState.players[playerIndex].prize = randomPrize;
        gameState.players[playerIndex].prizeType = prizeType;
    }
    
    updateRecentActivityList();
    updateWaitingPlayerList();
    saveGameState();

    // Display result
    const prizeAmountElement = document.getElementById('prize-amount');
    prizeAmountElement.textContent = randomPrize;
    
    if (prizeType === 'special') {
        prizeAmountElement.classList.add('special');
    } else {
        prizeAmountElement.classList.remove('special');
    }
    
    document.getElementById('winner-name').textContent = gameState.currentPlayer;
    document.getElementById('winner-prize').textContent = randomPrize;
    
    // Show/hide withdraw button based on prize type
    const actionButtons = document.getElementById('prize-action-buttons');
    if (prizeType === 'money') {
        actionButtons.innerHTML = `
            <button class="btn btn-primary" onclick="navigateTo('withdraw')">üí∞ R√öT L√å X√å</button>
            <button class="btn btn-secondary" onclick="continueShaking()">üîÑ TI·∫æP T·ª§C CH∆†I</button>
        `;
    } else {
        actionButtons.innerHTML = `
            <button class="btn btn-primary" onclick="continueShaking()">üéä TI·∫æP T·ª§C CH∆†I</button>
        `;
    }
    
    navigateTo('result');
}

// Continue shaking
function continueShaking() {
    if (gameState.remainingShakes > 0) {
        navigateTo('shake');
        document.getElementById('remaining-shakes').textContent = gameState.remainingShakes;
    } else {
        alert('ƒê√£ h·∫øt l∆∞·ª£t l·∫Øc!');
        if (gameState.isHost) {
            navigateTo('host-observe');
        } else {
            navigateTo('home', true);
        }
    }
}

// Select withdraw option
let selectedWithdrawOption = '';
function selectWithdrawOption(option) {
    selectedWithdrawOption = option;
    document.querySelectorAll('.bank-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.getElementById('option-' + option).classList.add('selected');
    
    if (option === 'qr') {
        navigateTo('qr-upload');
    } else {
        navigateTo('bank-info');
    }
}

// QR preview
function previewQR(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('qr-preview-img').src = e.target.result;
            document.getElementById('qr-preview').classList.remove('hidden');
            document.getElementById('submit-qr-btn').disabled = false;
        };
        reader.readAsDataURL(file);
    }
}

// Submit QR code
function submitQRCode() {
    console.log('Submitting QR code for player:', gameState.currentPlayer);
    console.log('Prize:', gameState.currentPrize);
    
    document.getElementById('final-prize').textContent = gameState.currentPrize;
    navigateTo('success');
}

// Submit bank info
function submitBankInfo() {
    const bankName = document.getElementById('bank-name').value;
    const accountName = document.getElementById('account-name').value;
    const accountNumber = document.getElementById('account-number').value;

    if (!bankName || !accountName || !accountNumber) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }

    console.log('Bank info:', {
        player: gameState.currentPlayer,
        prize: gameState.currentPrize,
        bank: bankName,
        accountName: accountName,
        accountNumber: accountNumber
    });

    document.getElementById('final-prize').textContent = gameState.currentPrize;
    navigateTo('success');
}

// Update player list
function listenPlayersRealtime() {
  const { database, ref, onValue } = window.firebaseDB;

  onValue(ref(database, `rooms/${gameState.roomCode}/players`), (snapshot) => {
    const data = snapshot.val();

    gameState.players = [];

    if (data) {
      Object.values(data).forEach(player => {
        gameState.players.push(player);
      });
    }

    updatePlayerList();
    updateWaitingPlayerList();
  });
}

// Update prize inventory
function updatePrizeInventory() {
    const container = document.getElementById('prize-inventory');
    container.innerHTML = '';
    
    // Display money prizes
    for (const [denom, qty] of Object.entries(gameState.denominations)) {
        const total = gameState.denominationsBackup[denom] || qty;
        const claimed = total - qty;
        
        const item = document.createElement('div');
        item.className = 'prize-item';
        item.innerHTML = `
            <div class="prize-value">üí∞ ${denom}</div>
            <div class="prize-count ${claimed > 0 ? 'claimed' : ''}">${claimed} / ${total}</div>
        `;
        container.appendChild(item);
    }
    
    // Display special prizes
    for (const [prize, qty] of Object.entries(gameState.specialPrizes)) {
        const total = gameState.specialPrizesBackup[prize] || qty;
        const claimed = total - qty;
        
        const item = document.createElement('div');
        item.className = 'prize-item special';
        item.innerHTML = `
            <div class="prize-value">
                üéÅ ${prize}
                <span class="prize-type-badge">Kh√°c</span>
            </div>
            <div class="prize-count ${claimed > 0 ? 'claimed' : ''}">${claimed} / ${total}</div>
        `;
        container.appendChild(item);
    }
}

// Share room
function shareRoom() {
    const shareTitle = 'L·∫Øc L√¨ X√¨ T·∫øt 2026';
    const shareText = `M·ªùi b·∫°n tham gia ph√≤ng l√¨ x√¨ ${gameState.roomCode}`;
    const shareUrl = gameState.roomLink;
    
    console.log('=== DEBUG SHARE ===');
    console.log('navigator.share available:', !!navigator.share);
    console.log('navigator.canShare available:', !!navigator.canShare);
    console.log('Share data:', { title: shareTitle, text: shareText, url: shareUrl });
    console.log('Protocol:', window.location.protocol);
    
    // Ki·ªÉm tra h·ªó tr·ª£ Web Share API
    if (navigator.share) {
        const shareData = {
            title: shareTitle,
            text: shareText,
            url: shareUrl
        };
        
        // Ki·ªÉm tra xem data c√≥ th·ªÉ share ƒë∆∞·ª£c kh√¥ng
        if (navigator.canShare && !navigator.canShare(shareData)) {
            console.log('‚ö†Ô∏è Data kh√¥ng th·ªÉ share, d√πng fallback');
            fallbackShare(shareTitle, shareText, shareUrl);
            return;
        }
        
        console.log('Attempting navigator.share()...');
        
        // S·ª≠ d·ª•ng native share sheet c·ªßa h·ªá ƒëi·ªÅu h√†nh
        navigator.share(shareData)
        .then(() => {
            console.log('‚úÖ Chia s·∫ª th√†nh c√¥ng');
        })
        .catch(err => {
            console.log('‚ùå L·ªói chia s·∫ª:', err.name, err.message, err);
            // Ch·ªâ fallback n·∫øu KH√îNG ph·∫£i user cancel
            if (err.name !== 'AbortError') {
                fallbackShare(shareTitle, shareText, shareUrl);
            }
        });
    } else {
        console.log('‚ö†Ô∏è navigator.share kh√¥ng kh·∫£ d·ª•ng, d√πng fallback');
        // Fallback cho tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£
        fallbackShare(shareTitle, shareText, shareUrl);
    }
}

function fallbackShare(title, text, url) {
    const fullText = `${title}\n\n${text}\n${url}`;
    
    // Th·ª≠ copy v√†o clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(fullText)
            .then(() => {
                showToast('‚úÖ ƒê√£ sao ch√©p link chia s·∫ª!');
            })
            .catch(() => {
                // Fallback cu·ªëi c√πng: textarea method
                fallbackCopyTextArea(fullText);
            });
    } else {
        // D√πng textarea method cho c√°c tr√¨nh duy·ªát c≈©
        fallbackCopyTextArea(fullText);
    }
}

function fallbackCopyTextArea(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('‚úÖ ƒê√£ sao ch√©p link chia s·∫ª!');
        } else {
            showToast('‚ö†Ô∏è Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast('‚ö†Ô∏è Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i.');
    }
    
    document.body.removeChild(textArea);
}

function showToast(message) {
    // T·∫°o toast notification ƒë∆°n gi·∫£n
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        animation: fadeInOut 2.5s ease-in-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 2500);
}

// Confirm back actions
function confirmBackToHome() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t? Ph√≤ng s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i.')) {
        navigateTo('home', true);
    }
}

function confirmBackFromShake() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën quay l·∫°i?')) {
        goBack();
    }
}

// Touch support
function initTouchSupport() {
    try {
        const selectors = ['.btn', '.denom-btn', '.quantity-btn', '.back-btn', '.bank-option', '.upload-area', '.envelope', '.tab-btn'];
        
        selectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (element) {
                    element.style.cursor = 'pointer';
                    element.addEventListener('touchstart', function(e) {
                        // Touch support for iOS
                    }, { passive: true });
                }
            });
        });

        document.querySelectorAll('.radio-option label').forEach(label => {
            if (label) {
                label.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    const radio = this.previousElementSibling;
                    if (radio && radio.type === 'radio') {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                });
            }
        });
    } catch (e) {
        console.error('Error in initTouchSupport:', e);
    }
}

// Initialize
window.addEventListener('load', function() {
    console.log('App loading...');
    
    try {
        loadGameState();
        // ‚úÖ N·∫æU L√Ä HOST + C√ì ROOM ‚Üí QUAY L·∫†I ADMIN + LISTEN
if (gameState.isHost && gameState.roomCode) {
  navigateTo('admin', true);
  listenPlayersRealtime();
}
    } catch (e) {
        console.error('Failed to load game state:', e);
        showScreen('home');
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');
    if (roomCode) {
        console.log('Room code from URL:', roomCode);
        document.getElementById('join-room-code').value = roomCode;
        navigateTo('enter-name');
    } else {
        if (!gameState.currentScreen || gameState.currentScreen === 'home') {
            showScreen('home');
        }
    }

    setTimeout(() => {
        try {
            initTouchSupport();
        } catch (e) {
            console.error('Failed to init touch support:', e);
        }
    }, 100);
    
    console.log('App loaded successfully');
});
    </script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  set,
  get,
  onValue,
  update,
  remove,
  push
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB83HpHO5PRHkJ8YDLdDAySOmIQVtTtUXk",
  authDomain: "lac-li-xi-2026-8f32c.firebaseapp.com",
  databaseURL: "https://lac-li-xi-2026-8f32c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lac-li-xi-2026-8f32c",
  storageBucket: "lac-li-xi-2026-8f32c.firebasestorage.app",
  messagingSenderId: "230674094866",
  appId: "1:230674094866:web:d7fc3a0d9d357aba32b1cb"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

window.firebaseDB = {
  database,
  ref,
  set,
  get,
  onValue,
  update,
  remove,
  push
};

console.log("üî• FIREBASE READY");
</script>
</body>
</html>